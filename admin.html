<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Lautan Kita</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="assets/js/api.js"></script>
    <style>
        /* RESET & VARIABLES */
        :root {
            --primary: #0275d8;
            --primary-dark: #025aa5;
            --secondary: #6c757d;
            --success: #5cb85c;
            --danger: #d9534f;
            --warning: #f0ad4e;
            --light: #f8f9fa;
            --dark: #343a40;
            --sidebar-width: 260px;
            --transition: all 0.3s ease;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 10px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #f4f9ff;
            color: #333;
            display: flex;
            min-height: 100vh;
        }

        /* SIDEBAR */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            position: fixed;
            height: 100vh;
            padding: 25px 0;
            box-shadow: var(--shadow);
            z-index: 1000;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 0 25px 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .sidebar-header h2 {
            font-size: 24px;
            font-weight: 700;
        }

        .sidebar-header i {
            font-size: 28px;
            background: rgba(255, 255, 255, 0.15);
            padding: 10px;
            border-radius: 8px;
        }

        .sidebar-nav {
            padding: 0 15px;
            flex: 1;
            overflow-y: auto;
        }

        .sidebar-nav a {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 14px 20px;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            border-radius: var(--border-radius);
            margin-bottom: 8px;
            transition: var(--transition);
            font-weight: 500;
            cursor: pointer;
        }

        .sidebar-nav a:hover,
        .sidebar-nav a.active {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transform: translateX(5px);
        }

        .sidebar-nav a i {
            width: 20px;
            text-align: center;
            font-size: 18px;
        }

        .sidebar-logout {
            padding: 20px 25px 25px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: auto;
        }

        .logout-btn {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 14px 20px;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            border-radius: var(--border-radius);
            transition: var(--transition);
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            border: none;
            text-align: left;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transform: translateX(5px);
        }

        .logout-btn i {
            width: 20px;
            text-align: center;
            font-size: 18px;
        }

        .sidebar-footer {
            padding: 15px 25px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            text-align: center;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* MAIN CONTENT */
        .content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 30px;
            transition: var(--transition);
        }

        /* HEADER */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }

        .header-left h1 {
            font-size: 28px;
            color: var(--dark);
            font-weight: 700;
        }

        .header-left p {
            color: var(--secondary);
            margin-top: 5px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
            padding: 8px 15px;
            border-radius: 50px;
            box-shadow: var(--shadow);
            cursor: pointer;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        /* PAGE CONTENT */
        .page-content {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .page-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* STATS CARDS */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
        }

        .stat-card:nth-child(1)::before {
            background: var(--primary);
        }

        .stat-card:nth-child(2)::before {
            background: var(--warning);
        }

        .stat-card:nth-child(3)::before {
            background: var(--success);
        }

        .stat-card:nth-child(4)::before {
            background: var(--danger);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            margin-bottom: 20px;
            color: white;
        }

        .stat-card:nth-child(1) .stat-icon {
            background: var(--primary);
        }

        .stat-card:nth-child(2) .stat-icon {
            background: var(--warning);
        }

        .stat-card:nth-child(3) .stat-icon {
            background: var(--success);
        }

        .stat-card:nth-child(4) .stat-icon {
            background: var(--danger);
        }

        .stat-card h3 {
            font-size: 14px;
            color: var(--secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .stat-change {
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-change.positive {
            color: var(--success);
        }

        .stat-change.negative {
            color: var(--danger);
        }

        /* BUTTONS */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        /* TABLE */
        .table-container {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table thead {
            background: #f8f9fa;
        }

        .table th {
            padding: 18px 20px;
            text-align: left;
            font-weight: 700;
            color: var(--dark);
            border-bottom: 2px solid #eaeaea;
        }

        .table td {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            color: #555;
        }

        .table tbody tr:hover {
            background: #f9f9f9;
        }

        /* CARD */
        .card {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
        }

        .card h3 {
            font-size: 20px;
            color: var(--dark);
            margin-bottom: 15px;
        }

        /* RESPONSIVE */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
                width: 280px;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .content {
                margin-left: 0;
            }
        }

        /* MENU TOGGLE (MOBILE) */
        .menu-toggle {
            display: none;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            width: 50px;
            height: 50px;
            font-size: 22px;
            cursor: pointer;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
        }

        @media (max-width: 992px) {
            .menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        /* OVERLAY */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .overlay.active {
            display: block;
        }

        /* FORM STYLES */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="date"],
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group input[type="checkbox"] {
            margin-right: 8px;
        }

        .filter-input {
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 14px;
            min-width: 150px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* REVIEW CARD */
        .review-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            border-left: 4px solid #e5e7eb;
        }

        .review-card.pending {
            border-left-color: var(--warning);
        }

        .review-card.approved {
            border-left-color: var(--success);
        }

        .review-card.rejected {
            border-left-color: var(--danger);
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .review-user {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .review-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .review-rating {
            color: #fbbf24;
            font-size: 18px;
        }

        .review-content {
            margin: 12px 0;
            color: #374151;
            line-height: 1.6;
        }

        .review-product {
            font-size: 14px;
            color: #64748B;
            margin-bottom: 8px;
        }

        .review-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-approved {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-rejected {
            background: #fee2e2;
            color: #991b1b;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        /* MODAL STYLES */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eaeaea;
        }
    </style>
</head>

<body>
    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-sailboat"></i>
            <h2>Lautan Kita</h2>
        </div>

        <nav class="sidebar-nav">
            <a href="#" class="nav-link active" data-page="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
            <a href="#" class="nav-link" data-page="users">
                <i class="fas fa-users"></i>
                <span>Kelola Pengguna</span>
            </a>
            <a href="#" class="nav-link" data-page="products">
                <i class="fas fa-box-open"></i>
                <span>Kelola Produk</span>
            </a>
            <a href="#" class="nav-link" data-page="orders">
                <i class="fas fa-shopping-cart"></i>
                <span>Kelola Pesanan</span>
            </a>
            <a href="#" class="nav-link" data-page="transactions">
                <i class="fas fa-file-invoice-dollar"></i>
                <span>Laporan Transaksi</span>
            </a>
            <a href="#" class="nav-link" data-page="reviews">
                <i class="fas fa-star-half-alt"></i>
                <span>Moderasi Ulasan</span>
            </a>
        </nav>

        <div class="sidebar-logout">
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>

        <div class="sidebar-footer">
            <p>Â© 2025 Lautan Kita</p>
        </div>
    </div>

    <!-- OVERLAY (MOBILE) -->
    <div class="overlay"></div>

    <!-- MOBILE MENU TOGGLE -->
    <button class="menu-toggle" id="menuToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- MAIN CONTENT -->
    <div class="content">
        <!-- DASHBOARD PAGE -->
        <div class="page-content active" id="dashboard">
            <div class="header">
                <div class="header-left">
                    <h1>Dashboard Admin</h1>
                    <p>Ringkasan aktivitas dan statistik sistem</p>
                </div>

                <div class="header-right">
                    <div class="user-profile">
                        <div class="user-avatar" id="userAvatar">A</div>
                        <div>
                            <div style="font-weight: 600;" id="userName">Admin</div>
                            <div style="font-size: 13px; color: #6c757d;">Administrator</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STATS CARDS -->
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3>Total Pengguna</h3>
                    <div class="stat-value" id="statUsers">0</div>
                    <div class="stat-change positive">
                        <i class="fas fa-arrow-up"></i>
                        <span>Terdaftar</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-box"></i>
                    </div>
                    <h3>Total Produk</h3>
                    <div class="stat-value" id="statProducts">0</div>
                    <div class="stat-change positive">
                        <i class="fas fa-arrow-up"></i>
                        <span>Aktif</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <h3>Total Pesanan</h3>
                    <div class="stat-value" id="statOrders">0</div>
                    <div class="stat-change positive">
                        <i class="fas fa-arrow-up"></i>
                        <span>Transaksi</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-star"></i>
                    </div>
                    <h3>Total Ulasan</h3>
                    <div class="stat-value" id="statReviews">0</div>
                    <div class="stat-change positive">
                        <i class="fas fa-arrow-up"></i>
                        <span>Review</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Selamat Datang di Admin Panel</h3>
                <p>Gunakan menu di sidebar untuk mengelola sistem Lautan Kita.</p>
            </div>
        </div>

        <!-- USERS PAGE -->
        <div class="page-content" id="users">
            <div class="header">
                <div class="header-left">
                    <h1>Kelola Pengguna</h1>
                    <p>Manajemen user dan role</p>
                </div>
            </div>

            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nama</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Verified</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="6" style="text-align: center;">Memuat data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- PRODUCTS PAGE -->
        <div class="page-content" id="products">
            <div class="header">
                <div class="header-left">
                    <h1>Kelola Produk</h1>
                    <p>Manajemen produk dan moderasi</p>
                </div>
            </div>

            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nama Produk</th>
                            <th>Penjual</th>
                            <th>Harga</th>
                            <th>Stok</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        <tr>
                            <td colspan="7" style="text-align: center;">Memuat data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ORDERS PAGE -->
        <div class="page-content" id="orders">
            <div class="header">
                <div class="header-left">
                    <h1>Kelola Pesanan</h1>
                    <p>Manajemen pesanan dan transaksi</p>
                </div>
            </div>

            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Pembeli</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Tanggal</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                        <tr>
                            <td colspan="6" style="text-align: center;">Memuat data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- TRANSACTIONS PAGE -->
        <div class="page-content" id="transactions">
            <div class="header">
                <div class="header-left">
                    <h1>Laporan Transaksi & Keuangan</h1>
                    <p>Lihat dan analisis semua transaksi dengan filter lengkap</p>
                </div>
                <div class="header-right">
                    <button class="btn btn-primary" onclick="exportTransactions()">
                        <i class="fas fa-file-csv"></i> Export CSV
                    </button>
                    <button class="btn btn-success" onclick="exportFinancialPDF()">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                </div>
            </div>

            <div class="card" style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;"><i class="fas fa-filter"></i> Filter Laporan Keuangan</h3>
                
                <!-- Filter by Month/Year -->
                <div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <label style="font-weight: 600; margin-bottom: 10px; display: block; color: var(--primary);">
                        <i class="fas fa-calendar-check"></i> Filter Per Bulan / Tahun:
                    </label>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
                        <div>
                            <label style="font-weight: 500; margin-bottom: 5px; display: block; font-size: 13px;">Bulan:</label>
                            <select id="filterMonth" class="filter-input" onchange="onMonthYearChange()">
                                <option value="">Semua Bulan</option>
                                <option value="1">Januari</option>
                                <option value="2">Februari</option>
                                <option value="3">Maret</option>
                                <option value="4">April</option>
                                <option value="5">Mei</option>
                                <option value="6">Juni</option>
                                <option value="7">Juli</option>
                                <option value="8">Agustus</option>
                                <option value="9">September</option>
                                <option value="10">Oktober</option>
                                <option value="11">November</option>
                                <option value="12">Desember</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight: 500; margin-bottom: 5px; display: block; font-size: 13px;">Tahun:</label>
                            <select id="filterYear" class="filter-input" onchange="onMonthYearChange()">
                                <option value="">Semua Tahun</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="loadFinancialReport()">
                            <i class="fas fa-chart-bar"></i> Lihat Laporan
                        </button>
                    </div>
                </div>
                
                <!-- Quick Period Filter -->
                <div style="margin-bottom: 15px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Periode Cepat:</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-secondary period-btn" onclick="setQuickPeriod('today')">
                            <i class="fas fa-calendar-day"></i> Hari Ini
                        </button>
                        <button class="btn btn-secondary period-btn" onclick="setQuickPeriod('week')">
                            <i class="fas fa-calendar-week"></i> 7 Hari Terakhir
                        </button>
                        <button class="btn btn-secondary period-btn" onclick="setQuickPeriod('month')">
                            <i class="fas fa-calendar-alt"></i> Bulan Ini
                        </button>
                        <button class="btn btn-secondary period-btn" onclick="setQuickPeriod('quarter')">
                            <i class="fas fa-calendar"></i> 3 Bulan
                        </button>
                        <button class="btn btn-secondary period-btn" onclick="setQuickPeriod('year')">
                            <i class="fas fa-calendar"></i> Tahun Ini
                        </button>
                        <button class="btn btn-secondary period-btn" onclick="setQuickPeriod('all')">
                            <i class="fas fa-infinity"></i> Semua
                        </button>
                    </div>
                </div>
                
                <!-- Custom Date Range -->
                <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
                    <div>
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">Dari Tanggal:</label>
                        <input type="date" id="filterDateFrom" class="filter-input">
                    </div>
                    <div>
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">Sampai Tanggal:</label>
                        <input type="date" id="filterDateTo" class="filter-input">
                    </div>
                    <div>
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">Status Pembayaran:</label>
                        <select id="filterPaymentStatus" class="filter-input">
                            <option value="">Semua Status</option>
                            <option value="belum_dibayar">Belum Dibayar</option>
                            <option value="sudah_dibayar">Sudah Dibayar</option>
                            <option value="gagal">Gagal</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="applyTransactionFilter()">
                        <i class="fas fa-search"></i> Terapkan Filter
                    </button>
                    <button class="btn btn-secondary" onclick="resetTransactionFilter()">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                </div>
                
                <!-- Current Period Display -->
                <div id="currentPeriodDisplay" style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 8px; display: none;">
                    <i class="fas fa-info-circle" style="color: var(--primary);"></i>
                    <span id="periodText" style="font-weight: 500;"></span>
                </div>
            </div>

            <!-- Financial Summary Cards -->
            <div class="stats-container" id="financialStats">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-money-bill-wave"></i></div>
                    <h3>Total Pendapatan</h3>
                    <div class="stat-value" id="finTotalPendapatan">Rp 0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                    <h3>Transaksi Berhasil</h3>
                    <div class="stat-value" id="finTransaksiBerhasil">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-clock"></i></div>
                    <h3>Transaksi Pending</h3>
                    <div class="stat-value" id="finTransaksiPending">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-times-circle"></i></div>
                    <h3>Transaksi Gagal</h3>
                    <div class="stat-value" id="finTransaksiGagal">0</div>
                </div>
            </div>

            <!-- Monthly Chart Section -->
            <div class="card" style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;"><i class="fas fa-chart-line"></i> Grafik Pendapatan Bulanan</h3>
                <div id="monthlyChartContainer" style="height: 250px; display: flex; align-items: flex-end; gap: 8px; padding: 20px 0;">
                    <p style="color: #64748B; text-align: center; width: 100%;">Memuat data...</p>
                </div>
            </div>

            <!-- Top Sellers & Products -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div class="card">
                    <h3 style="margin-bottom: 15px;"><i class="fas fa-trophy"></i> Top 5 Penjual</h3>
                    <div id="topSellersContainer">
                        <p style="color: #64748B; text-align: center;">Memuat data...</p>
                    </div>
                </div>
                <div class="card">
                    <h3 style="margin-bottom: 15px;"><i class="fas fa-star"></i> Top 5 Produk Terlaris</h3>
                    <div id="topProductsContainer">
                        <p style="color: #64748B; text-align: center;">Memuat data...</p>
                    </div>
                </div>
            </div>

            <!-- Transaction Table -->
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID Transaksi</th>
                            <th>Pesanan</th>
                            <th>Pembeli</th>
                            <th>Total</th>
                            <th>Metode</th>
                            <th>Status</th>
                            <th>Tanggal</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTableBody">
                        <tr>
                            <td colspan="8" style="text-align: center;">Memuat data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="card" style="margin-top: 20px;">
                <h3>Ringkasan Transaksi</h3>
                <div
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px;">
                    <div>
                        <div style="color: #64748B; font-size: 14px;">Total Transaksi</div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--dark);" id="summaryTotal">Rp 0</div>
                    </div>
                    <div>
                        <div style="color: #64748B; font-size: 14px;">Transaksi Berhasil</div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--success);" id="summaryConfirmed">0
                        </div>
                    </div>
                    <div>
                        <div style="color: #64748B; font-size: 14px;">Transaksi Pending</div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--warning);" id="summaryPending">0
                        </div>
                    </div>
                    <div>
                        <div style="color: #64748B; font-size: 14px;">Transaksi Gagal</div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--danger);" id="summaryFailed">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- REVIEWS PAGE -->
        <div class="page-content" id="reviews">
            <div class="header">
                <div class="header-left">
                    <h1>Moderasi Ulasan</h1>
                    <p>Kelola ulasan dan rating produk</p>
                </div>
            </div>

            <div class="card" style="margin-bottom: 20px;">
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <select id="filterReviewStatus" class="filter-input" onchange="loadReviews()">
                        <option value="">Semua Status</option>
                        <option value="aktif">Aktif (Ditampilkan)</option>
                        <option value="disembunyikan">Disembunyikan</option>
                    </select>
                    <select id="filterReviewRating" class="filter-input" onchange="loadReviews()">
                        <option value="">Semua Rating</option>
                        <option value="5">5 Bintang</option>
                        <option value="4">4 Bintang</option>
                        <option value="3">3 Bintang</option>
                        <option value="2">2 Bintang</option>
                        <option value="1">1 Bintang</option>
                    </select>
                </div>
            </div>

            <div id="reviewsContainer">
                <div style="text-align: center; padding: 40px; color: #64748B;">
                    Memuat ulasan...
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL EDIT USER -->
    <div class="modal" id="editUserModal">
        <div class="modal-content">
            <div class="modal-title">Edit Pengguna</div>
            <form id="editUserForm">
                <div class="form-group">
                    <label>Nama *</label>
                    <input type="text" id="editUserName" required>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="editUserEmail" required>
                </div>
                <div class="form-group">
                    <label>Role *</label>
                    <select id="editUserRole" required>
                        <option value="pembeli">Pembeli</option>
                        <option value="penjual">Penjual</option>
                        <option value="kurir">Kurir</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="editUserVerified">
                        Verified
                    </label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditUserModal()">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL REVIEW DETAIL -->
    <div class="modal" id="reviewDetailModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-title">Detail Ulasan</div>
            <div id="reviewDetailContent"></div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeReviewModal()">Tutup</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = (window.API && window.API.base) || 'http://localhost:4000';

        // Navigation
        document.addEventListener('DOMContentLoaded', function () {
            checkAuth();
            loadDashboardData();

            // Mobile menu
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.overlay');

            if (menuToggle) {
                menuToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('active');
                    overlay.classList.toggle('active');
                });
            }

            if (overlay) {
                overlay.addEventListener('click', () => {
                    sidebar.classList.remove('active');
                    overlay.classList.remove('active');
                });
            }

            // Nav links
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = link.getAttribute('data-page');
                    showPage(page);

                    navLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');

                    // Load data for page
                    if (page === 'users') loadUsers();
                    if (page === 'products') loadProducts();
                    if (page === 'orders') loadOrders();
                    if (page === 'transactions') loadTransactions();
                    if (page === 'reviews') loadReviews();
                });
            });
        });

        async function checkAuth() {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const resp = await API.authFetch('/auth/me');
                if (!resp.ok) {
                    window.location.href = 'login.html';
                    return;
                }

                const user = await resp.json();
                if (user.role !== 'admin') {
                    API.showModal({
                        title: 'Akses Ditolak',
                        message: 'Halaman ini hanya untuk admin.',
                        actions: [{ label: 'OK', variant: 'primary', handler: () => { window.location.href = 'home_final.html'; } }]
                    });
                    return;
                }

                document.getElementById('userName').textContent = user.nama;
                document.getElementById('userAvatar').textContent = user.nama.charAt(0).toUpperCase();
            } catch (e) {
                console.error('Auth check failed:', e);
                window.location.href = 'login.html';
            }
        }

        function showPage(pageName) {
            const pages = document.querySelectorAll('.page-content');
            pages.forEach(page => page.classList.remove('active'));

            const targetPage = document.getElementById(pageName);
            if (targetPage) {
                targetPage.classList.add('active');
            }
        }

        async function loadDashboardData() {
            try {
                // Load comprehensive stats
                const resp = await API.authFetch('/admin/stats');
                if (resp.ok) {
                    const stats = await resp.json();

                    // Update dashboard stats
                    document.getElementById('statUsers').textContent = stats.users.total_users || 0;
                    document.getElementById('statProducts').textContent = stats.products.total_products || 0;
                    document.getElementById('statOrders').textContent = stats.orders.total_orders || 0;
                    document.getElementById('statRevenue').textContent = `Rp ${(stats.orders.total_revenue || 0).toLocaleString('id-ID')}`;

                    // Update additional stats if elements exist
                    const verifiedUsersEl = document.getElementById('statVerifiedUsers');
                    if (verifiedUsersEl) verifiedUsersEl.textContent = stats.users.verified_users || 0;

                    const activeProductsEl = document.getElementById('statActiveProducts');
                    if (activeProductsEl) activeProductsEl.textContent = stats.products.active_products || 0;

                    const completedOrdersEl = document.getElementById('statCompletedOrders');
                    if (completedOrdersEl) completedOrdersEl.textContent = stats.orders.completed_orders || 0;

                    const confirmedPaymentsEl = document.getElementById('statConfirmedPayments');
                    if (confirmedPaymentsEl) confirmedPaymentsEl.textContent = stats.payments.confirmed_payments || 0;
                }
            } catch (e) {
                console.error('Failed to load dashboard data:', e);
                // Fallback to individual requests
                try {
                    const [usersResp, productsResp] = await Promise.all([
                        API.authFetch('/admin/users'),
                        fetch(API_BASE + '/products')
                    ]);

                    if (usersResp.ok) {
                        const users = await usersResp.json();
                        document.getElementById('statUsers').textContent = users.length;
                    }

                    if (productsResp.ok) {
                        const products = await productsResp.json();
                        document.getElementById('statProducts').textContent = products.length;
                    }
                } catch (fallbackError) {
                    console.error('Fallback loading failed:', fallbackError);
                }
            }
        }

        async function loadUsers() {
            try {
                const resp = await API.authFetch('/admin/users');
                if (!resp.ok) throw new Error('Failed to load users');

                const users = await resp.json();
                const tbody = document.getElementById('usersTableBody');

                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Tidak ada data</td></tr>';
                    return;
                }

                tbody.innerHTML = users.map(user => `
                    <tr data-user-id="${user.user_id}">
                        <td>${user.user_id}</td>
                        <td>${user.nama}</td>
                        <td>${user.email}</td>
                        <td>${user.role}</td>
                        <td>${user.verified ? 'Ya' : 'Tidak'}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="editUser(${user.user_id})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Failed to load users:', e);
            }
        }

        async function loadProducts() {
            try {
                const resp = await fetch(API_BASE + '/products');
                if (!resp.ok) throw new Error('Failed to load products');

                const products = await resp.json();
                const tbody = document.getElementById('productsTableBody');

                if (products.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Tidak ada data</td></tr>';
                    return;
                }

                tbody.innerHTML = products.map(product => `
                    <tr>
                        <td>${product.produk_id}</td>
                        <td>${product.nama_produk}</td>
                        <td>${product.penjual_nama || '-'}</td>
                        <td>Rp ${Number(product.harga).toLocaleString('id-ID')}</td>
                        <td>${product.stok}</td>
                        <td>${product.status}</td>
                        <td>
                            <button class="btn btn-primary" onclick="editProduct(${product.produk_id})">Edit</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Failed to load products:', e);
            }
        }

        async function loadOrders() {
            try {
                const resp = await API.authFetch('/admin/orders');
                if (!resp.ok) throw new Error('Failed to load orders');

                const orders = await resp.json();
                const tbody = document.getElementById('ordersTableBody');

                if (orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Tidak ada pesanan</td></tr>';
                    return;
                }

                tbody.innerHTML = orders.map(order => {
                    const statusMap = {
                        'pending': { label: 'Menunggu', class: 'warning' },
                        'dikemas': { label: 'Dikemas', class: 'info' },
                        'dikirim': { label: 'Dikirim', class: 'primary' },
                        'selesai': { label: 'Selesai', class: 'success' },
                        'dibatalkan': { label: 'Dibatalkan', class: 'danger' }
                    };

                    const status = statusMap[order.status_pesanan] || { label: order.status_pesanan, class: 'secondary' };

                    return `
                        <tr>
                            <td>#${order.pesanan_id}</td>
                            <td>${order.pembeli_nama}</td>
                            <td>${order.total_items} item</td>
                            <td>Rp ${Number(order.total_harga).toLocaleString('id-ID')}</td>
                            <td>
                                <span class="badge badge-${status.class}">${status.label}</span>
                            </td>
                            <td>${new Date(order.created_at).toLocaleDateString('id-ID')}</td>
                            <td>
                                <select onchange="updateOrderStatus(${order.pesanan_id}, this.value)" class="form-control form-control-sm">
                                    <option value="">Ubah Status</option>
                                    <option value="menunggu" ${order.status_pesanan === 'menunggu' || order.status_pesanan === 'pending' ? 'selected' : ''}>Menunggu</option>
                                    <option value="diproses" ${order.status_pesanan === 'diproses' || order.status_pesanan === 'dikemas' ? 'selected' : ''}>Diproses</option>
                                    <option value="dikirim" ${order.status_pesanan === 'dikirim' ? 'selected' : ''}>Dikirim</option>
                                    <option value="selesai" ${order.status_pesanan === 'selesai' ? 'selected' : ''}>Selesai</option>
                                    <option value="dibatalkan" ${order.status_pesanan === 'dibatalkan' ? 'selected' : ''}>Dibatalkan</option>
                                </select>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (e) {
                console.error('Failed to load orders:', e);
                const tbody = document.getElementById('ordersTableBody');
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Gagal memuat data pesanan</td></tr>';
            }
        }

        async function updateOrderStatus(orderId, newStatus) {
            if (!newStatus) return;

            if (!confirm(`Ubah status pesanan #${orderId} menjadi ${newStatus}?`)) {
                // Reset select value
                loadOrders();
                return;
            }

            try {
                const resp = await API.authFetch(`/admin/orders/${orderId}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status_pesanan: newStatus })
                });

                if (resp.ok) {
                    API.showModal({
                        title: 'Berhasil',
                        message: 'Status pesanan berhasil diubah',
                        actions: [{ label: 'OK', variant: 'primary', handler: () => { API.hideModal(); loadOrders(); } }]
                    });
                } else {
                    throw new Error('Failed to update status');
                }
            } catch (e) {
                console.error('Failed to update order status:', e);
                API.showModal({ title: 'Error', message: 'Gagal mengubah status pesanan' });
                loadOrders(); // Reset the select
            }
        }

        let currentEditUserId = null;
        let allTransactions = [];
        let allReviews = [];

        // Quick Period Filter Functions
        function setQuickPeriod(period) {
            const today = new Date();
            let fromDate = new Date();
            let toDate = new Date();
            let periodText = '';
            
            // Reset active state on all buttons
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            });
            
            // Set active state on clicked button
            event.target.closest('.period-btn').classList.remove('btn-secondary');
            event.target.closest('.period-btn').classList.add('btn-primary');
            
            // Clear month/year filters
            document.getElementById('filterMonth').value = '';
            document.getElementById('filterYear').value = '';
            
            switch(period) {
                case 'today':
                    fromDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                    toDate = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59);
                    periodText = `Menampilkan data hari ini (${today.toLocaleDateString('id-ID')})`;
                    break;
                case 'week':
                    fromDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                    periodText = `Menampilkan data 7 hari terakhir (${fromDate.toLocaleDateString('id-ID')} - ${today.toLocaleDateString('id-ID')})`;
                    break;
                case 'month':
                    fromDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    periodText = `Menampilkan data bulan ini (${monthNames[today.getMonth()]} ${today.getFullYear()})`;
                    break;
                case 'quarter':
                    fromDate = new Date(today.getFullYear(), today.getMonth() - 3, today.getDate());
                    periodText = `Menampilkan data 3 bulan terakhir (${fromDate.toLocaleDateString('id-ID')} - ${today.toLocaleDateString('id-ID')})`;
                    break;
                case 'year':
                    fromDate = new Date(today.getFullYear(), 0, 1);
                    periodText = `Menampilkan data tahun ${today.getFullYear()}`;
                    break;
                case 'all':
                    fromDate = null;
                    toDate = null;
                    periodText = 'Menampilkan semua data transaksi';
                    break;
            }
            
            // Update date inputs
            if (fromDate) {
                document.getElementById('filterDateFrom').value = fromDate.toISOString().split('T')[0];
            } else {
                document.getElementById('filterDateFrom').value = '';
            }
            
            if (toDate && period !== 'all') {
                document.getElementById('filterDateTo').value = toDate.toISOString().split('T')[0];
            } else {
                document.getElementById('filterDateTo').value = '';
            }
            
            // Show period display
            const periodDisplay = document.getElementById('currentPeriodDisplay');
            const periodTextEl = document.getElementById('periodText');
            if (periodDisplay && periodTextEl) {
                periodDisplay.style.display = 'block';
                periodTextEl.textContent = periodText;
            }
            
            // Apply filter
            renderTransactions();
            updateTransactionSummary();
        }
        
        function applyTransactionFilter() {
            const dateFrom = document.getElementById('filterDateFrom')?.value;
            const dateTo = document.getElementById('filterDateTo')?.value;
            
            // Update period display
            const periodDisplay = document.getElementById('currentPeriodDisplay');
            const periodTextEl = document.getElementById('periodText');
            
            if (periodDisplay && periodTextEl) {
                if (dateFrom || dateTo) {
                    const fromText = dateFrom ? new Date(dateFrom).toLocaleDateString('id-ID') : 'Awal';
                    const toText = dateTo ? new Date(dateTo).toLocaleDateString('id-ID') : 'Sekarang';
                    periodDisplay.style.display = 'block';
                    periodTextEl.textContent = `Menampilkan data dari ${fromText} sampai ${toText}`;
                } else {
                    periodDisplay.style.display = 'block';
                    periodTextEl.textContent = 'Menampilkan semua data transaksi';
                }
            }
            
            // Reset quick period buttons
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            });
            
            renderTransactions();
            updateTransactionSummary();
        }
        
        function resetTransactionFilter() {
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('filterPaymentStatus').value = '';
            
            // Reset quick period buttons
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            });
            
            // Hide period display
            const periodDisplay = document.getElementById('currentPeriodDisplay');
            if (periodDisplay) {
                periodDisplay.style.display = 'none';
            }
            
            renderTransactions();
            updateTransactionSummary();
        }

        async function loadTransactions() {
            try {
                // Initialize year filter
                await initYearFilter();
                
                const resp = await API.authFetch('/admin/transactions');
                if (!resp.ok) throw new Error('Failed to load transactions');

                allTransactions = await resp.json();
                renderTransactions();
                updateTransactionSummary();
                
                // Also load financial report
                await loadFinancialReport();
            } catch (e) {
                console.error('Failed to load transactions:', e);
                document.getElementById('transactionsTableBody').innerHTML = `
                    <tr><td colspan="8" style="text-align: center; color: var(--danger);">Gagal memuat transaksi</td></tr>
                `;
            }
        }

        function renderTransactions() {
            const tbody = document.getElementById('transactionsTableBody');
            const dateFrom = document.getElementById('filterDateFrom')?.value;
            const dateTo = document.getElementById('filterDateTo')?.value;
            const statusFilter = document.getElementById('filterPaymentStatus')?.value;

            let filtered = allTransactions.filter(t => {
                const transactionDate = new Date(t.tanggal_pembayaran || t.created_at);
                
                if (statusFilter && t.status_pembayaran !== statusFilter) return false;
                
                if (dateFrom) {
                    const fromDate = new Date(dateFrom);
                    fromDate.setHours(0, 0, 0, 0);
                    if (transactionDate < fromDate) return false;
                }
                
                if (dateTo) {
                    const toDate = new Date(dateTo);
                    toDate.setHours(23, 59, 59, 999);
                    if (transactionDate > toDate) return false;
                }
                
                return true;
            });

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Tidak ada transaksi</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(t => {
                const statusMap = {
                    'belum_dibayar': { label: 'Belum Dibayar', class: 'warning' },
                    'sudah_dibayar': { label: 'Sudah Dibayar', class: 'success' },
                    'gagal': { label: 'Gagal', class: 'danger' }
                };

                const status = statusMap[t.status_pembayaran] || { label: t.status_pembayaran, class: 'secondary' };

                return `
                    <tr>
                        <td>#${t.pembayaran_id}</td>
                        <td>#${t.pesanan_id}</td>
                        <td>${t.pembeli_nama || '-'}</td>
                        <td>Rp ${Number(t.jumlah_bayar || 0).toLocaleString('id-ID')}</td>
                        <td>${t.metode || '-'}</td>
                        <td>
                            <span class="badge badge-${status.class}">
                                ${status.label}
                            </span>
                        </td>
                        <td>${t.tanggal_pembayaran ? new Date(t.tanggal_pembayaran).toLocaleDateString('id-ID') : '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewTransactionDetail(${t.pembayaran_id})">
                                <i class="fas fa-eye"></i> Detail
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateTransactionSummary() {
            // Get filtered data based on current filters
            const dateFrom = document.getElementById('filterDateFrom')?.value;
            const dateTo = document.getElementById('filterDateTo')?.value;
            const statusFilter = document.getElementById('filterPaymentStatus')?.value;

            let filtered = allTransactions.filter(t => {
                const transactionDate = new Date(t.tanggal_pembayaran || t.created_at);
                
                if (statusFilter && t.status_pembayaran !== statusFilter) return false;
                
                if (dateFrom) {
                    const fromDate = new Date(dateFrom);
                    fromDate.setHours(0, 0, 0, 0);
                    if (transactionDate < fromDate) return false;
                }
                
                if (dateTo) {
                    const toDate = new Date(dateTo);
                    toDate.setHours(23, 59, 59, 999);
                    if (transactionDate > toDate) return false;
                }
                
                return true;
            });

            const total = filtered.reduce((sum, t) => sum + Number(t.jumlah_bayar || 0), 0);
            const confirmed = filtered.filter(t => t.status_pembayaran === 'sudah_dibayar').length;
            const pending = filtered.filter(t => t.status_pembayaran === 'belum_dibayar').length;
            const failed = filtered.filter(t => t.status_pembayaran === 'gagal').length;

            const summaryTotalEl = document.getElementById('summaryTotal');
            const summaryConfirmedEl = document.getElementById('summaryConfirmed');
            const summaryPendingEl = document.getElementById('summaryPending');
            const summaryFailedEl = document.getElementById('summaryFailed');

            if (summaryTotalEl) summaryTotalEl.textContent = `Rp ${total.toLocaleString('id-ID')}`;
            if (summaryConfirmedEl) summaryConfirmedEl.textContent = confirmed;
            if (summaryPendingEl) summaryPendingEl.textContent = pending;
            if (summaryFailedEl) summaryFailedEl.textContent = failed;
        }

        function viewTransactionDetail(transactionId) {
            const transaction = allTransactions.find(t => t.pembayaran_id === transactionId);
            if (!transaction) return;

            API.showModal({
                title: `Detail Transaksi #${transactionId}`,
                message: `
                    <div style="text-align: left;">
                        <p><strong>Pesanan:</strong> #${transaction.pesanan_id}</p>
                        <p><strong>Pembeli:</strong> ${transaction.pembeli_nama || '-'}</p>
                        <p><strong>Total:</strong> Rp ${Number(transaction.jumlah_bayar || 0).toLocaleString('id-ID')}</p>
                        <p><strong>Metode:</strong> ${transaction.metode_pembayaran || '-'}</p>
                        <p><strong>Status:</strong> ${transaction.status_pembayaran}</p>
                        <p><strong>Tanggal:</strong> ${new Date(transaction.tanggal_pembayaran).toLocaleString('id-ID')}</p>
                        ${transaction.bukti_transfer ? `<p><strong>Bukti Transfer:</strong> <a href="${API_BASE}${transaction.bukti_transfer}" target="_blank">Lihat</a></p>` : ''}
                    </div>
                `,
                actions: [{ label: 'Tutup', variant: 'primary', handler: API.hideModal }]
            });
        }

        function exportTransactions() {
            // Get filtered data based on current filters
            const dateFrom = document.getElementById('filterDateFrom')?.value;
            const dateTo = document.getElementById('filterDateTo')?.value;
            const statusFilter = document.getElementById('filterPaymentStatus')?.value;

            let filtered = allTransactions.filter(t => {
                const transactionDate = new Date(t.tanggal_pembayaran || t.created_at);
                
                if (statusFilter && t.status_pembayaran !== statusFilter) return false;
                
                if (dateFrom) {
                    const fromDate = new Date(dateFrom);
                    fromDate.setHours(0, 0, 0, 0);
                    if (transactionDate < fromDate) return false;
                }
                
                if (dateTo) {
                    const toDate = new Date(dateTo);
                    toDate.setHours(23, 59, 59, 999);
                    if (transactionDate > toDate) return false;
                }
                
                return true;
            });

            if (filtered.length === 0) {
                API.showModal({ title: 'Info', message: 'Tidak ada data untuk diexport dengan filter yang dipilih' });
                return;
            }

            // Calculate summary for export
            const total = filtered.reduce((sum, t) => sum + Number(t.jumlah_bayar || 0), 0);
            const confirmed = filtered.filter(t => t.status_pembayaran === 'sudah_dibayar').length;
            const pending = filtered.filter(t => t.status_pembayaran === 'belum_dibayar').length;
            const failed = filtered.filter(t => t.status_pembayaran === 'gagal').length;

            // Build period text for filename
            let periodText = 'semua';
            if (dateFrom && dateTo) {
                periodText = `${dateFrom}_sampai_${dateTo}`;
            } else if (dateFrom) {
                periodText = `dari_${dateFrom}`;
            } else if (dateTo) {
                periodText = `sampai_${dateTo}`;
            }

            const csv = [
                ['LAPORAN KEUANGAN - LAUTAN KITA'],
                [`Periode: ${dateFrom || 'Awal'} - ${dateTo || 'Sekarang'}`],
                [`Tanggal Export: ${new Date().toLocaleString('id-ID')}`],
                [''],
                ['RINGKASAN'],
                [`Total Transaksi,Rp ${total.toLocaleString('id-ID')}`],
                [`Transaksi Berhasil,${confirmed}`],
                [`Transaksi Pending,${pending}`],
                [`Transaksi Gagal,${failed}`],
                [''],
                ['DETAIL TRANSAKSI'],
                ['ID', 'Pesanan', 'Pembeli', 'Total', 'Metode', 'Status', 'Tanggal'].join(','),
                ...filtered.map(t => [
                    t.pembayaran_id,
                    t.pesanan_id,
                    `"${t.pembeli_nama || '-'}"`,
                    t.jumlah_bayar || 0,
                    t.metode || t.metode_pembayaran || '-',
                    t.status_pembayaran,
                    new Date(t.tanggal_pembayaran || t.created_at).toLocaleDateString('id-ID')
                ].join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `laporan_keuangan_${periodText}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            API.showModal({ 
                title: 'Export Berhasil', 
                message: `${filtered.length} transaksi berhasil diexport ke file CSV.` 
            });
        }

        // Financial Report Data
        let financialReportData = null;
        const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];

        // Initialize year filter options
        async function initYearFilter() {
            try {
                const resp = await API.authFetch('/admin/reports/yearly');
                if (resp.ok) {
                    const data = await resp.json();
                    const yearSelect = document.getElementById('filterYear');
                    if (yearSelect && data.availableYears) {
                        // Add current year if not in list
                        const currentYear = new Date().getFullYear();
                        const years = [...new Set([currentYear, ...data.availableYears])].sort((a, b) => b - a);
                        
                        yearSelect.innerHTML = '<option value="">Semua Tahun</option>' + 
                            years.map(y => `<option value="${y}">${y}</option>`).join('');
                    }
                }
            } catch (e) {
                console.error('Failed to init year filter:', e);
            }
        }

        // Handle month/year filter change
        function onMonthYearChange() {
            const month = document.getElementById('filterMonth')?.value;
            const year = document.getElementById('filterYear')?.value;
            
            // Clear date range filters when using month/year
            if (month || year) {
                document.getElementById('filterDateFrom').value = '';
                document.getElementById('filterDateTo').value = '';
                
                // Reset quick period buttons
                document.querySelectorAll('.period-btn').forEach(btn => {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-secondary');
                });
            }
        }

        // Load financial report with filters
        async function loadFinancialReport() {
            const month = document.getElementById('filterMonth')?.value;
            const year = document.getElementById('filterYear')?.value;
            const dateFrom = document.getElementById('filterDateFrom')?.value;
            const dateTo = document.getElementById('filterDateTo')?.value;
            
            // Build query params
            const params = new URLSearchParams();
            if (month) params.append('month', month);
            if (year) params.append('year', year);
            if (dateFrom) params.append('from', dateFrom);
            if (dateTo) params.append('to', dateTo);
            
            try {
                const resp = await API.authFetch(`/admin/reports/financial?${params.toString()}`);
                if (!resp.ok) throw new Error('Failed to load financial report');
                
                financialReportData = await resp.json();
                
                // Update summary cards
                updateFinancialSummary(financialReportData.summary);
                
                // Update monthly chart
                renderMonthlyChart(financialReportData.monthly);
                
                // Update top sellers
                renderTopSellers(financialReportData.topSellers);
                
                // Update top products
                renderTopProducts(financialReportData.topProducts);
                
                // Update period display
                updatePeriodDisplay(month, year, dateFrom, dateTo);
                
            } catch (e) {
                console.error('Failed to load financial report:', e);
                API.showModal({ title: 'Error', message: 'Gagal memuat laporan keuangan' });
            }
        }

        function updateFinancialSummary(summary) {
            if (!summary) return;
            
            const totalPendapatan = document.getElementById('finTotalPendapatan');
            const berhasil = document.getElementById('finTransaksiBerhasil');
            const pending = document.getElementById('finTransaksiPending');
            const gagal = document.getElementById('finTransaksiGagal');
            
            if (totalPendapatan) totalPendapatan.textContent = `Rp ${Number(summary.total_pendapatan || 0).toLocaleString('id-ID')}`;
            if (berhasil) berhasil.textContent = summary.transaksi_berhasil || 0;
            if (pending) pending.textContent = summary.transaksi_pending || 0;
            if (gagal) gagal.textContent = summary.transaksi_gagal || 0;
        }

        function renderMonthlyChart(monthly) {
            const container = document.getElementById('monthlyChartContainer');
            if (!container) return;
            
            if (!monthly || monthly.length === 0) {
                container.innerHTML = '<p style="color: #64748B; text-align: center; width: 100%;">Tidak ada data bulanan</p>';
                return;
            }
            
            // Find max value for scaling
            const maxValue = Math.max(...monthly.map(m => Number(m.pendapatan || 0)));
            
            // Render bar chart
            container.innerHTML = monthly.slice(0, 12).reverse().map(m => {
                const [year, month] = m.bulan.split('-');
                const monthName = monthNames[parseInt(month) - 1]?.substring(0, 3) || month;
                const value = Number(m.pendapatan || 0);
                const height = maxValue > 0 ? (value / maxValue * 180) : 0;
                
                return `
                    <div style="display: flex; flex-direction: column; align-items: center; flex: 1; min-width: 50px;">
                        <div style="font-size: 10px; color: #64748B; margin-bottom: 4px;">
                            Rp ${(value / 1000000).toFixed(1)}jt
                        </div>
                        <div style="width: 100%; max-width: 40px; height: ${Math.max(height, 5)}px; background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%); border-radius: 4px 4px 0 0; transition: height 0.3s;"></div>
                        <div style="font-size: 11px; color: #374151; margin-top: 8px; font-weight: 500;">${monthName}</div>
                        <div style="font-size: 10px; color: #64748B;">${year}</div>
                    </div>
                `;
            }).join('');
        }

        function renderTopSellers(sellers) {
            const container = document.getElementById('topSellersContainer');
            if (!container) return;
            
            if (!sellers || sellers.length === 0) {
                container.innerHTML = '<p style="color: #64748B; text-align: center;">Tidak ada data penjual</p>';
                return;
            }
            
            container.innerHTML = sellers.slice(0, 5).map((s, i) => `
                <div style="display: flex; align-items: center; padding: 12px; background: ${i === 0 ? '#FEF3C7' : '#f8f9fa'}; border-radius: 8px; margin-bottom: 8px;">
                    <div style="width: 30px; height: 30px; background: ${i === 0 ? '#F59E0B' : i === 1 ? '#9CA3AF' : i === 2 ? '#CD7F32' : 'var(--primary)'}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 12px;">
                        ${i + 1}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #374151;">${s.penjual_nama}</div>
                        <div style="font-size: 12px; color: #64748B;">${s.jumlah_transaksi} transaksi</div>
                    </div>
                    <div style="font-weight: 700; color: var(--success);">
                        Rp ${Number(s.total_penjualan || 0).toLocaleString('id-ID')}
                    </div>
                </div>
            `).join('');
        }

        function renderTopProducts(products) {
            const container = document.getElementById('topProductsContainer');
            if (!container) return;
            
            if (!products || products.length === 0) {
                container.innerHTML = '<p style="color: #64748B; text-align: center;">Tidak ada data produk</p>';
                return;
            }
            
            container.innerHTML = products.slice(0, 5).map((p, i) => `
                <div style="display: flex; align-items: center; padding: 12px; background: ${i === 0 ? '#DBEAFE' : '#f8f9fa'}; border-radius: 8px; margin-bottom: 8px;">
                    <div style="width: 30px; height: 30px; background: ${i === 0 ? 'var(--primary)' : '#6B7280'}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 12px;">
                        ${i + 1}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #374151;">${p.nama_produk}</div>
                        <div style="font-size: 12px; color: #64748B;">oleh ${p.penjual_nama} â¢ ${p.total_terjual} terjual</div>
                    </div>
                    <div style="font-weight: 700; color: var(--success);">
                        Rp ${Number(p.total_pendapatan || 0).toLocaleString('id-ID')}
                    </div>
                </div>
            `).join('');
        }

        function updatePeriodDisplay(month, year, dateFrom, dateTo) {
            const periodDisplay = document.getElementById('currentPeriodDisplay');
            const periodTextEl = document.getElementById('periodText');
            
            if (!periodDisplay || !periodTextEl) return;
            
            let text = '';
            if (month && year) {
                text = `Menampilkan laporan bulan ${monthNames[parseInt(month) - 1]} ${year}`;
            } else if (year) {
                text = `Menampilkan laporan tahun ${year}`;
            } else if (dateFrom && dateTo) {
                text = `Menampilkan laporan dari ${new Date(dateFrom).toLocaleDateString('id-ID')} sampai ${new Date(dateTo).toLocaleDateString('id-ID')}`;
            } else if (dateFrom) {
                text = `Menampilkan laporan dari ${new Date(dateFrom).toLocaleDateString('id-ID')}`;
            } else if (dateTo) {
                text = `Menampilkan laporan sampai ${new Date(dateTo).toLocaleDateString('id-ID')}`;
            } else {
                text = 'Menampilkan semua data laporan keuangan';
            }
            
            periodDisplay.style.display = 'block';
            periodTextEl.textContent = text;
        }

        // Export Financial Report to PDF
        async function exportFinancialPDF() {
            if (!financialReportData) {
                await loadFinancialReport();
            }
            
            if (!financialReportData) {
                API.showModal({ title: 'Error', message: 'Tidak ada data untuk diexport' });
                return;
            }
            
            const month = document.getElementById('filterMonth')?.value;
            const year = document.getElementById('filterYear')?.value;
            const dateFrom = document.getElementById('filterDateFrom')?.value;
            const dateTo = document.getElementById('filterDateTo')?.value;
            
            // Build period text
            let periodText = 'Semua Periode';
            let filenamePeriod = 'semua';
            if (month && year) {
                periodText = `${monthNames[parseInt(month) - 1]} ${year}`;
                filenamePeriod = `${year}-${month.padStart(2, '0')}`;
            } else if (year) {
                periodText = `Tahun ${year}`;
                filenamePeriod = year;
            } else if (dateFrom && dateTo) {
                periodText = `${new Date(dateFrom).toLocaleDateString('id-ID')} - ${new Date(dateTo).toLocaleDateString('id-ID')}`;
                filenamePeriod = `${dateFrom}_${dateTo}`;
            }
            
            const today = new Date();
            const formattedDate = today.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });
            
            // Build monthly rows
            let monthlyRows = '';
            if (financialReportData.monthly && financialReportData.monthly.length > 0) {
                financialReportData.monthly.forEach(m => {
                    const [yr, mn] = m.bulan.split('-');
                    monthlyRows += `
                        <tr>
                            <td style="border: 1px solid #000; padding: 8px;">${monthNames[parseInt(mn) - 1]} ${yr}</td>
                            <td style="border: 1px solid #000; padding: 8px; text-align: center;">${m.jumlah_transaksi || 0}</td>
                            <td style="border: 1px solid #000; padding: 8px; text-align: center;">${m.berhasil || 0}</td>
                            <td style="border: 1px solid #000; padding: 8px; text-align: right;">Rp ${Number(m.pendapatan || 0).toLocaleString('id-ID')}</td>
                        </tr>
                    `;
                });
            }
            
            // Build top sellers rows
            let sellersRows = '';
            if (financialReportData.topSellers && financialReportData.topSellers.length > 0) {
                financialReportData.topSellers.slice(0, 10).forEach((s, i) => {
                    sellersRows += `
                        <tr>
                            <td style="border: 1px solid #000; padding: 8px; text-align: center;">${i + 1}</td>
                            <td style="border: 1px solid #000; padding: 8px;">${s.penjual_nama}</td>
                            <td style="border: 1px solid #000; padding: 8px; text-align: center;">${s.jumlah_transaksi}</td>
                            <td style="border: 1px solid #000; padding: 8px; text-align: right;">Rp ${Number(s.total_penjualan || 0).toLocaleString('id-ID')}</td>
                        </tr>
                    `;
                });
            }
            
            // Build top products rows
            let productsRows = '';
            if (financialReportData.topProducts && financialReportData.topProducts.length > 0) {
                financialReportData.topProducts.slice(0, 10).forEach((p, i) => {
                    productsRows += `
                        <tr>
                            <td style="border: 1px solid #000; padding: 8px; text-align: center;">${i + 1}</td>
                            <td style="border: 1px solid #000; padding: 8px;">${p.nama_produk}</td>
                            <td style="border: 1px solid #000; padding: 8px;">${p.penjual_nama}</td>
                            <td style="border: 1px solid #000; padding: 8px; text-align: center;">${p.total_terjual}</td>
                            <td style="border: 1px solid #000; padding: 8px; text-align: right;">Rp ${Number(p.total_pendapatan || 0).toLocaleString('id-ID')}</td>
                        </tr>
                    `;
                });
            }
            
            const summary = financialReportData.summary || {};
            
            // Create PDF content
            const pdfContent = document.createElement('div');
            pdfContent.innerHTML = `
                <div style="padding: 30px; font-family: 'Times New Roman', Times, serif; color: #000; font-size: 12px; line-height: 1.5;">
                    <!-- Header -->
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h1 style="margin: 0; font-size: 18px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px;">LAPORAN KEUANGAN</h1>
                        <h2 style="margin: 5px 0; font-size: 14px; font-weight: normal;">Lautan Kita - Marketplace Hasil Laut</h2>
                        <p style="margin: 5px 0; font-size: 12px;">Periode: ${periodText}</p>
                    </div>

                    <hr style="border: none; border-top: 2px solid #000; margin: 15px 0;">

                    <!-- Info -->
                    <table style="width: 100%; margin-bottom: 20px; font-size: 12px;">
                        <tr>
                            <td style="width: 120px;">Tanggal Cetak</td>
                            <td style="width: 10px;">:</td>
                            <td>${formattedDate}</td>
                        </tr>
                        <tr>
                            <td>Dicetak Oleh</td>
                            <td>:</td>
                            <td>Administrator</td>
                        </tr>
                    </table>

                    <!-- Ringkasan -->
                    <h3 style="font-size: 13px; margin: 20px 0 10px; border-bottom: 1px solid #000; padding-bottom: 5px;">I. RINGKASAN KEUANGAN</h3>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <tr>
                            <td style="padding: 5px 0; width: 200px;">Total Pendapatan</td>
                            <td style="padding: 5px 0; width: 10px;">:</td>
                            <td style="padding: 5px 0; text-align: right; font-weight: bold;">Rp ${Number(summary.total_pendapatan || 0).toLocaleString('id-ID')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px 0;">Total Transaksi</td>
                            <td style="padding: 5px 0;">:</td>
                            <td style="padding: 5px 0; text-align: right;">${summary.total_transaksi || 0} transaksi</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px 0;">Transaksi Berhasil</td>
                            <td style="padding: 5px 0;">:</td>
                            <td style="padding: 5px 0; text-align: right;">${summary.transaksi_berhasil || 0} transaksi</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px 0;">Transaksi Pending</td>
                            <td style="padding: 5px 0;">:</td>
                            <td style="padding: 5px 0; text-align: right;">${summary.transaksi_pending || 0} transaksi</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px 0;">Transaksi Gagal</td>
                            <td style="padding: 5px 0;">:</td>
                            <td style="padding: 5px 0; text-align: right;">${summary.transaksi_gagal || 0} transaksi</td>
                        </tr>
                    </table>

                    <!-- Rekapitulasi Bulanan -->
                    <h3 style="font-size: 13px; margin: 20px 0 10px; border-bottom: 1px solid #000; padding-bottom: 5px;">II. REKAPITULASI BULANAN</h3>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <thead>
                            <tr style="background: #f0f0f0;">
                                <th style="border: 1px solid #000; padding: 8px; text-align: left;">Periode</th>
                                <th style="border: 1px solid #000; padding: 8px; text-align: center;">Total Transaksi</th>
                                <th style="border: 1px solid #000; padding: 8px; text-align: center;">Berhasil</th>
                                <th style="border: 1px solid #000; padding: 8px; text-align: right;">Pendapatan</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${monthlyRows || '<tr><td colspan="4" style="border: 1px solid #000; padding: 8px; text-align: center;">Tidak ada data</td></tr>'}
                        </tbody>
                    </table>

                    <!-- Top Penjual -->
                    <h3 style="font-size: 13px; margin: 20px 0 10px; border-bottom: 1px solid #000; padding-bottom: 5px;">III. TOP 10 PENJUAL</h3>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <thead>
                            <tr style="background: #f0f0f0;">
                                <th style="border: 1px solid #000; padding: 8px; text-align: center; width: 40px;">No</th>
                                <th style="border: 1px solid #000; padding: 8px; text-align: left;">Nama Penjual</th>
                                <th style="border: 1px solid #000; padding: 8px; text-align: center;">Transaksi</th>
                                <th style="border: 1px solid #000; padding: 8px; text-align: right;">Total Penjualan</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sellersRows || '<tr><td colspan="4" style="border: 1px solid #000; padding: 8px; text-align: center;">Tidak ada data</td></tr>'}
                        </tbody>
                    </table>

                    <!-- Top Produk -->
                    <h3 style="font-size: 13px; margin: 20px 0 10px; border-bottom: 1px solid #000; padding-bottom: 5px;">IV. TOP 10 PRODUK TERLARIS</h3>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <thead>
                            <tr style="background: #f0f0f0;">
                                <th style="border: 1px solid #000; padding: 8px; text-align: center; width: 40px;">No</th>
                                <th style="border: 1px solid #000; padding: 8px; text-align: left;">Nama Produk</th>
                                <th style="border: 1px solid #000; padding: 8px; text-align: left;">Penjual</th>
                                <th style="border: 1px solid #000; padding: 8px; text-align: center;">Terjual</th>
                                <th style="border: 1px solid #000; padding: 8px; text-align: right;">Pendapatan</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${productsRows || '<tr><td colspan="5" style="border: 1px solid #000; padding: 8px; text-align: center;">Tidak ada data</td></tr>'}
                        </tbody>
                    </table>

                    <!-- Footer -->
                    <div style="margin-top: 40px;">
                        <div style="float: right; text-align: center; width: 200px;">
                            <p style="margin: 0;">${formattedDate}</p>
                            <p style="margin: 40px 0 5px;">_______________________</p>
                            <p style="margin: 0; font-weight: bold;">Administrator</p>
                        </div>
                        <div style="clear: both;"></div>
                    </div>

                    <hr style="border: none; border-top: 1px solid #ccc; margin: 30px 0 10px;">
                    <p style="text-align: center; font-size: 10px; color: #666; margin: 0;">
                        Dokumen ini digenerate secara otomatis oleh sistem Lautan Kita pada ${today.toLocaleString('id-ID')}<br>
                        Â© ${today.getFullYear()} Lautan Kita - Marketplace Hasil Laut
                    </p>
                </div>
            `;

            // Check if html2pdf is available
            if (typeof html2pdf === 'undefined') {
                // Load html2pdf dynamically
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
                script.onload = () => generatePDF(pdfContent, filenamePeriod);
                document.head.appendChild(script);
            } else {
                generatePDF(pdfContent, filenamePeriod);
            }
        }

        function generatePDF(content, filenamePeriod) {
            const opt = {
                margin: 10,
                filename: `Laporan-Keuangan-Admin-${filenamePeriod}-${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(content).save().then(() => {
                API.showModal({
                    title: 'Berhasil',
                    message: 'Laporan keuangan berhasil diexport ke PDF!',
                    actions: [{ label: 'OK', variant: 'primary', handler: () => API.hideModal() }]
                });
            });
        }

        async function loadReviews() {
            try {
                const resp = await API.authFetch('/admin/reviews');
                if (!resp.ok) throw new Error('Failed to load reviews');

                allReviews = await resp.json();
                renderReviews();
            } catch (e) {
                console.error('Failed to load reviews:', e);
                document.getElementById('reviewsContainer').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--danger);">Gagal memuat ulasan</div>
                `;
            }
        }

        function renderReviews() {
            const container = document.getElementById('reviewsContainer');
            const statusFilter = document.getElementById('filterReviewStatus')?.value;
            const ratingFilter = document.getElementById('filterReviewRating')?.value;

            let filtered = allReviews.filter(r => {
                if (statusFilter && r.status !== statusFilter) return false;
                if (ratingFilter && r.rating != ratingFilter) return false;
                return true;
            });

            if (filtered.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #64748B;">Tidak ada ulasan</div>';
                return;
            }

            container.innerHTML = filtered.map(r => `
                <div class="review-card ${r.status === 'aktif' ? 'approved' : 'rejected'}">
                    <div class="review-header">
                        <div class="review-user">
                            <div class="review-avatar">${(r.pembeli_nama || 'U').charAt(0).toUpperCase()}</div>
                            <div>
                                <div style="font-weight: 600;">${r.pembeli_nama || 'User'}</div>
                                <div class="review-rating">${'â'.repeat(r.rating)}${'â'.repeat(5 - r.rating)}</div>
                            </div>
                        </div>
                        <span class="badge badge-${r.status === 'aktif' ? 'approved' : 'rejected'}">${r.status === 'aktif' ? 'Aktif' : 'Disembunyikan'}</span>
                    </div>
                    <div class="review-product">
                        <i class="fas fa-box"></i> ${r.nama_produk || 'Produk'}
                    </div>
                    <div class="review-content">${r.komentar || '-'}</div>
                    ${r.balasan_admin ? `
                        <div style="background: #E0F2FE; padding: 12px; border-radius: 8px; margin-top: 12px; border-left: 3px solid var(--primary);">
                            <div style="font-size: 12px; color: var(--primary); font-weight: 600; margin-bottom: 4px;">
                                <i class="fas fa-reply"></i> Balasan Admin
                            </div>
                            <div style="color: #374151;">${r.balasan_admin}</div>
                        </div>
                    ` : ''}
                    <div style="font-size: 13px; color: #64748B; margin-top: 8px;">
                        ${new Date(r.tanggal_ulasan).toLocaleDateString('id-ID')}
                    </div>
                    <div class="review-actions">
                        ${r.status !== 'aktif' ? `<button class="btn btn-sm btn-success" onclick="approveReview(${r.ulasan_id})">
                            <i class="fas fa-check"></i> Tampilkan
                        </button>` : ''}
                        ${r.status !== 'disembunyikan' ? `<button class="btn btn-sm btn-danger" onclick="rejectReview(${r.ulasan_id})">
                            <i class="fas fa-times"></i> Sembunyikan
                        </button>` : ''}
                        <button class="btn btn-sm btn-primary" onclick="viewReviewDetail(${r.ulasan_id})">
                            <i class="fas fa-eye"></i> Detail
                        </button>
                        <button class="btn btn-sm" style="background: #8B5CF6; color: white;" onclick="replyReview(${r.ulasan_id})">
                            <i class="fas fa-reply"></i> ${r.balasan_admin ? 'Edit Balasan' : 'Balas'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function approveReview(reviewId) {
            try {
                const resp = await API.authFetch(`/admin/reviews/${reviewId}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'aktif' })
                });

                if (resp.ok) {
                    API.showModal({
                        title: 'Berhasil',
                        message: 'Ulasan berhasil ditampilkan',
                        actions: [{ label: 'OK', variant: 'primary', handler: () => { API.hideModal(); loadReviews(); } }]
                    });
                } else {
                    API.showModal({ title: 'Error', message: 'Gagal menampilkan ulasan' });
                }
            } catch (e) {
                API.showModal({ title: 'Error', message: 'Terjadi kesalahan' });
            }
        }

        async function rejectReview(reviewId) {
            try {
                const resp = await API.authFetch(`/admin/reviews/${reviewId}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'disembunyikan' })
                });

                if (resp.ok) {
                    API.showModal({
                        title: 'Berhasil',
                        message: 'Ulasan berhasil disembunyikan',
                        actions: [{ label: 'OK', variant: 'primary', handler: () => { API.hideModal(); loadReviews(); } }]
                    });
                } else {
                    API.showModal({ title: 'Error', message: 'Gagal menyembunyikan ulasan' });
                }
            } catch (e) {
                API.showModal({ title: 'Error', message: 'Terjadi kesalahan' });
            }
        }

        function viewReviewDetail(reviewId) {
            closeAllModals(); // Close any open modal first
            const review = allReviews.find(r => r.ulasan_id === reviewId);
            if (!review) return;

            document.getElementById('reviewDetailContent').innerHTML = `
                <div style="text-align: left;">
                    <div style="margin-bottom: 15px;">
                        <strong>Pembeli:</strong> ${review.pembeli_nama || 'User'}<br>
                        <strong>Produk:</strong> ${review.nama_produk || '-'}<br>
                        <strong>Rating:</strong> <span style="color: #fbbf24;">${'â'.repeat(review.rating)}${'â'.repeat(5 - review.rating)}</span><br>
                        <strong>Status:</strong> <span class="badge badge-${review.status || 'pending'}">${review.status || 'pending'}</span>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>Komentar:</strong><br>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-top: 8px;">
                            ${review.komentar || '-'}
                        </div>
                    </div>
                    <div style="font-size: 13px; color: #64748B;">
                        Tanggal: ${new Date(review.tanggal_ulasan).toLocaleString('id-ID')}
                    </div>
                </div>
            `;
            document.getElementById('reviewDetailModal').classList.add('active');
        }

        function closeReviewModal() {
            document.getElementById('reviewDetailModal').classList.remove('active');
        }

        function replyReview(reviewId) {
            closeAllModals(); // Close any open modal first
            const review = allReviews.find(r => r.ulasan_id === reviewId);
            if (!review) return;

            document.getElementById('reviewDetailContent').innerHTML = `
                <div style="text-align: left;">
                    <div style="margin-bottom: 15px;">
                        <strong>Pembeli:</strong> ${review.pembeli_nama || 'User'}<br>
                        <strong>Produk:</strong> ${review.nama_produk || '-'}<br>
                        <strong>Rating:</strong> <span style="color: #fbbf24;">${'â'.repeat(review.rating)}${'â'.repeat(5 - review.rating)}</span>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>Komentar Pembeli:</strong>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-top: 8px;">
                            ${review.komentar || '-'}
                        </div>
                    </div>
                    <div class="form-group">
                        <label><strong>Balasan Admin:</strong></label>
                        <textarea id="replyText" rows="4" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; resize: vertical;">${review.balasan_admin || ''}</textarea>
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="closeReviewModal()">Batal</button>
                        <button class="btn btn-primary" onclick="submitReply(${reviewId})">
                            <i class="fas fa-paper-plane"></i> Kirim Balasan
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('reviewDetailModal').classList.add('active');
        }

        async function submitReply(reviewId) {
            const balasan = document.getElementById('replyText').value.trim();
            if (!balasan) {
                API.showModal({ title: 'Error', message: 'Balasan tidak boleh kosong' });
                return;
            }

            try {
                const resp = await API.authFetch(`/admin/reviews/${reviewId}/reply`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ balasan })
                });

                if (resp.ok) {
                    closeReviewModal();
                    API.showModal({
                        title: 'Berhasil',
                        message: 'Balasan berhasil dikirim',
                        actions: [{ label: 'OK', variant: 'primary', handler: () => { API.hideModal(); loadReviews(); } }]
                    });
                } else {
                    API.showModal({ title: 'Error', message: 'Gagal mengirim balasan' });
                }
            } catch (e) {
                API.showModal({ title: 'Error', message: 'Terjadi kesalahan' });
            }
        }

        function editUser(userId) {
            const user = document.querySelector(`#usersTableBody tr[data-user-id="${userId}"]`);
            if (!user) {
                // Fallback: find from loaded data
                API.authFetch('/admin/users').then(r => r.json()).then(users => {
                    const userData = users.find(u => u.user_id === userId);
                    if (userData) openEditUserModal(userData);
                });
                return;
            }

            // Get user data from table
            const cells = user.querySelectorAll('td');
            const userData = {
                user_id: userId,
                nama: cells[1].textContent,
                email: cells[2].textContent,
                role: cells[3].textContent,
                verified: cells[4].textContent === 'Ya'
            };

            openEditUserModal(userData);
        }

        // Helper function to close all modals
        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
        }

        function openEditUserModal(user) {
            closeAllModals(); // Close any open modal first
            currentEditUserId = user.user_id;
            document.getElementById('editUserName').value = user.nama;
            document.getElementById('editUserEmail').value = user.email;
            document.getElementById('editUserRole').value = user.role;
            document.getElementById('editUserVerified').checked = user.verified;
            document.getElementById('editUserModal').classList.add('active');
        }

        function closeEditUserModal() {
            document.getElementById('editUserModal').classList.remove('active');
            currentEditUserId = null;
        }

        document.getElementById('editUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                nama: document.getElementById('editUserName').value.trim(),
                email: document.getElementById('editUserEmail').value.trim(),
                role: document.getElementById('editUserRole').value,
                verified: document.getElementById('editUserVerified').checked
            };

            try {
                const resp = await API.authFetch(`/admin/users/${currentEditUserId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (resp.ok) {
                    closeEditUserModal();
                    API.showModal({
                        title: 'Berhasil',
                        message: 'Data user berhasil diupdate',
                        actions: [{ label: 'OK', variant: 'primary', handler: () => { API.hideModal(); loadUsers(); } }]
                    });
                } else {
                    const error = await resp.json();
                    API.showModal({ title: 'Error', message: error.error || 'Gagal update user' });
                }
            } catch (e) {
                API.showModal({ title: 'Error', message: 'Terjadi kesalahan jaringan' });
            }
        });

        function editProduct(productId) {
            API.showModal({ title: 'Edit Product', message: `Edit product ID: ${productId} (fitur akan segera tersedia)` });
        }

        function logout() {
            localStorage.removeItem('auth_token');
            window.location.href = 'login.html';
        }

        // Close modal when clicking outside
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
    </script>
</body>

</html>