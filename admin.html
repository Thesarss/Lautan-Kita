<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; margin:0; background:#f3f6f9; color:#0f172a; }
    .wrap { max-width: 980px; margin: 20px auto; padding: 0 16px; }
    h1 { margin: 8px 0 16px; }
    .tabs { display:flex; gap:8px; margin-bottom:12px; }
    .tab { padding:10px 14px; border-radius:8px; cursor:pointer; background:#e2e8f0; }
    .tab.active { background:#93c5fd; color:#0c4a6e; font-weight:600; }
    .card { background:#fff; border-radius:10px; box-shadow:0 6px 16px rgba(0,0,0,0.08); padding:16px; margin-bottom:16px; }
    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding:10px; border-bottom:1px solid #e5e7eb; }
    th { background:#f8fafc; }
    .actions { display:flex; gap:8px; }
    .btn { border:none; border-radius:8px; padding:8px 12px; cursor:pointer; }
    .btn.primary { background:#2563eb; color:#fff; }
    .btn.secondary { background:#e5e7eb; color:#111827; }
    .search { display:flex; gap:8px; margin-bottom:10px; }
    input, select { padding:8px; border:1px solid #cbd5e1; border-radius:8px; }
  </style>
  <script src="assets/js/api.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>Admin Panel</h1>
    <div class="tabs">
      <div class="tab active" id="tabUsers" onclick="showTab('users')">Pengguna</div>
      <div class="tab" id="tabReviews" onclick="showTab('reviews')">Ulasan</div>
    </div>

    <div id="usersView" class="card">
      <div class="search">
        <input id="userSearch" type="text" placeholder="Cari nama/email" />
        <select id="userRoleFilter">
          <option value="">Semua peran</option>
          <option value="pembeli">Pembeli</option>
          <option value="penjual">Penjual</option>
          <option value="admin">Admin</option>
        </select>
        <button class="btn secondary" onclick="loadUsers()">Muat</button>
      </div>
      <table>
        <thead>
          <tr><th>ID</th><th>Nama</th><th>Email</th><th>Role</th><th>Verified</th><th>Aksi</th></tr>
        </thead>
        <tbody id="usersTbody"></tbody>
      </table>
    </div>

    <div id="reviewsView" class="card" style="display:none">
      <div class="search">
        <input id="revSearch" type="text" placeholder="Cari komentar/nama produk" />
        <select id="revStatusFilter">
          <option value="">Semua status</option>
          <option value="aktif">Aktif</option>
          <option value="disembunyikan">Disembunyikan</option>
        </select>
        <button class="btn secondary" onclick="loadReviews()">Muat</button>
      </div>
      <table>
        <thead>
          <tr><th>ID</th><th>Produk</th><th>Pengulas</th><th>Rating</th><th>Status</th><th>Aksi</th></tr>
        </thead>
        <tbody id="reviewsTbody"></tbody>
      </table>
    </div>
  </div>

  <script>
    function showTab(name){
      document.getElementById('tabUsers').classList.toggle('active', name==='users');
      document.getElementById('tabReviews').classList.toggle('active', name==='reviews');
      document.getElementById('usersView').style.display = (name==='users') ? 'block' : 'none';
      document.getElementById('reviewsView').style.display = (name==='reviews') ? 'block' : 'none';
    }

    async function loadUsers(){
      const q = document.getElementById('userSearch').value.trim();
      const role = document.getElementById('userRoleFilter').value;
      const qs = new URLSearchParams();
      if (q) qs.set('q', q);
      if (role) qs.set('role', role);
      const resp = await API.authFetch('/admin/users' + (qs.toString() ? ('?' + qs.toString()) : ''));
      if (!resp.ok) { API.showModal({ title:'Admin', message:'Gagal memuat pengguna' }); return; }
      const rows = await resp.json();
      const tb = document.getElementById('usersTbody');
      tb.innerHTML = '';
      rows.forEach(u => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${u.user_id}</td><td>${u.nama||'-'}</td><td>${u.email}</td><td>${u.role}</td><td>${u.verified? 'Ya':'Tidak'}</td>
          <td class='actions'>
            <select onchange="updateUserRole(${u.user_id}, this.value)">
              <option value="pembeli" ${u.role==='pembeli'?'selected':''}>Pembeli</option>
              <option value="penjual" ${u.role==='penjual'?'selected':''}>Penjual</option>
              <option value="admin" ${u.role==='admin'?'selected':''}>Admin</option>
            </select>
            <button class='btn primary' onclick="verifyUser(${u.user_id}, ${u.verified?0:1})">${u.verified? 'Unverify':'Verify'}</button>
          </td>`;
        tb.appendChild(tr);
      });
    }

    async function updateUserRole(id, role){
      const resp = await API.authFetch('/admin/users/' + id + '/role', { method:'PATCH', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ role }) });
      if (!resp.ok) { API.showModal({ title:'Admin', message:'Gagal mengubah role' }); return; }
      API.showModal({ title:'Admin', message:'Role diperbarui' });
    }
    async function verifyUser(id, verified){
      const resp = await API.authFetch('/admin/users/' + id + '/verify', { method:'PATCH', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ verified }) });
      if (!resp.ok) { API.showModal({ title:'Admin', message:'Gagal mengubah verifikasi' }); return; }
      loadUsers();
      API.showModal({ title:'Admin', message:'Status verifikasi diperbarui' });
    }

    async function loadReviews(){
      const q = document.getElementById('revSearch').value.trim();
      const status = document.getElementById('revStatusFilter').value;
      const qs = new URLSearchParams();
      if (q) qs.set('q', q);
      if (status) qs.set('status', status);
      const resp = await API.authFetch('/admin/reviews' + (qs.toString() ? ('?' + qs.toString()) : ''));
      if (!resp.ok) { API.showModal({ title:'Admin', message:'Gagal memuat ulasan' }); return; }
      const rows = await resp.json();
      const tb = document.getElementById('reviewsTbody');
      tb.innerHTML = '';
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.ulasan_id}</td><td>${r.nama_produk}</td><td>${r.user_nama}</td><td>${r.rating}</td><td>${r.status}</td>
          <td class='actions'>
            <select onchange="updateReviewStatus(${r.ulasan_id}, this.value)">
              <option value='aktif' ${r.status==='aktif'?'selected':''}>Aktif</option>
              <option value='disembunyikan' ${r.status==='disembunyikan'?'selected':''}>Disembunyikan</option>
            </select>
          </td>`;
        tb.appendChild(tr);
      });
    }
    async function updateReviewStatus(id, status){
      const resp = await API.authFetch('/admin/reviews/' + id + '/status', { method:'PATCH', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ status }) });
      if (!resp.ok) { API.showModal({ title:'Admin', message:'Gagal mengubah status ulasan' }); return; }
      API.showModal({ title:'Admin', message:'Status ulasan diperbarui' });
    }

    (function init(){ showTab('users'); loadUsers(); })();
  </script>
</body>
</html>
