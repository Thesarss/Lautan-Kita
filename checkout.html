<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      background-color: #e9f3f9;
      color: #1a1a1a;
    }

    .container {
      max-width: 800px;
      margin: auto;
      padding: 20px;
    }

    .back-arrow {
      display: flex;
      align-items: center;
      margin-bottom: 18px;
      cursor: pointer;
      user-select: none;
    }

    .back-arrow svg {
      width: 24px;
      height: 24px;
      margin-right: 8px;
    }

    .user-info,
    .seller-info {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .user-info img,
    .seller-info img {
      border-radius: 50%;
      width: 50px;
      height: 50px;
      margin-right: 10px;
    }

    .card {
      background-color: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .product-container {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }

    .product-image-container {
      flex: 1;
      min-width: 150px;
    }

    .product-info-container {
      flex: 2;
    }

    .product-img {
      width: 100%;
      max-height: 200px;
      object-fit: contain;
      border-radius: 10px;
    }

    .qty-box {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 15px;
    }

    .qty-box button {
      padding: 5px 15px;
      font-size: 16px;
      background-color: #0077cc;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .qty-box button:hover {
      background-color: #005fa3;
    }

    .shipping-options {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: space-between;
    }

    .shipping-option {
      background: #f0f4f8;
      padding: 10px;
      border-radius: 10px;
      text-align: center;
      flex: 1;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.3s;
    }

    .shipping-option:hover {
      background: #e0e8f0;
    }

    .shipping-option.active {
      border-color: #0077cc;
      background-color: #d0ecff;
    }

    .note {
      background-color: #dceff8;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .price-summary {
      margin-bottom: 20px;
      background: #f8fafc;
      padding: 15px;
      border-radius: 10px;
    }

    .price-summary div {
      display: flex;
      justify-content: space-between;
      margin: 8px 0;
    }

    .checkout-btn {
      background-color: #0077cc;
      color: white;
      padding: 15px;
      border: none;
      width: 100%;
      font-size: 16px;
      border-radius: 12px;
      cursor: pointer;
      transition: background-color 0.3s;
      font-weight: bold;
    }

    .checkout-btn:hover {
      background-color: #005fa3;
    }

    select {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #ccc;
      background-color: white;
    }

    .alert {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      border-radius: 8px;
      color: white;
      z-index: 1000;
      opacity: 1;
      transition: opacity 0.5s;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .alert.error {
      background-color: #ff4444;
    }

    .alert.success {
      background-color: #00C851;
    }

    .alert.fade-out {
      opacity: 0;
    }

    @media (max-width: 600px) {
      .product-container {
        flex-direction: column;
      }

      .product-image-container {
        width: 100%;
        text-align: center;
      }

      .product-img {
        width: 100%;
        max-height: 200px;
        object-fit: contain;
        border-radius: 10px;
        background-color: #f5f5f5;
        padding: 10px;
      }

      .shipping-options {
        flex-direction: column;
      }
    }
  </style>
  <script src="assets/js/api.js"></script>
</head>

<body>
  <div class="container">
    <!-- Arrow Back -->
    <div class="back-arrow" onclick="window.location.href='home_final.html'">
      <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M15 19l-7-7 7-7" />
      </svg>
      <span>Kembali ke Beranda</span>
    </div>

    <div class="user-info">
      <img id="userAvatar" src="img/pembeli.png" alt="Foto Pembeli">
      <div>
        <strong id="userName">Akun</strong><br>
        <small id="userSubtitle">Masuk untuk melihat detail</small>
      </div>
    </div>

    <div class="seller-info">
      <img src="img/penjual.png" alt="Foto Penjual">
      <div><strong id="seller-name">Budi fisherman</strong></div>
    </div>

    <div id="produk-container"></div>

    <div class="note">Catatan: Tambahkan ice pack dan bungkus yang tebal</div>

    <h4>Opsi pengiriman</h4>
    <div class="shipping-options">
      <div class="shipping-option" onclick="pilihKurir('Hemat', 5000, event)">Hemat<br><small>Rp.
          5.000</small><br><small>2 hari</small></div>
      <div class="shipping-option" onclick="pilihKurir('Standar', 10000, event)">Standar<br><small>Rp.
          10.000</small><br><small>1 jam</small></div>
      <div class="shipping-option active" onclick="pilihKurir('Express', 35000, event)">Express<br><small>Rp.
          35.000</small><br><small>30 menit</small></div>
    </div>

    <label for="pembayaran"><strong>Metode Pembayaran:</strong></label>
    <select id="pembayaran">
      <option value="BNI">BNI</option>
      <option value="BCA">BCA</option>
      <option value="Mandiri">Mandiri</option>
      <option value="COD">Bayar di Tempat (COD)</option>
    </select>

    <div class="price-summary">
      <div><span>Total Produk</span><span id="total-produk">Rp. 0</span></div>
      <div><span>Pengiriman</span><span id="ongkir">Rp. 35.000</span></div>
      <hr>
      <div><strong>Total Harga</strong><strong id="total-harga">Rp. 35.000</strong></div>
    </div>

    <button class="checkout-btn" id="checkoutBtn" onclick="checkout()">Checkout</button>
  </div>


  <script>
    // Fungsi tambah ke keranjang (bisa dipanggil dari halaman lain)
    // Gunakan: tambahKeKeranjang(id, name, image, price, qty)
    function tambahKeKeranjang(produkId, nama, gambar, harga, jumlah = 1) {
      const cart = JSON.parse(localStorage.getItem('cart_checkout')) || [];
      let found = cart.find(item => item.id === produkId);
      jumlah = parseInt(jumlah) || 1;
      if (found) {
        found.quantity += jumlah;
      } else {
        cart.push({
          id: produkId,
          name: nama,
          image: gambar,
          price: harga,
          quantity: jumlah
        });
      }
      localStorage.setItem('cart_checkout', JSON.stringify(cart));
      API.showModal({ title: 'Keranjang', message: 'Produk ditambahkan ke keranjang!', actions: [{ label: 'Lihat Keranjang', variant: 'primary', handler: function () { API.hideModal(); window.location.href = 'keranjang.html'; } }] });
    }



    // Variabel global
    let cartItems = [];
    let ongkir = 35000;
    let namaKurir = "Express";

    function showAlert(type, message) {
      const alertBox = document.createElement('div');
      alertBox.className = `alert ${type}`;
      alertBox.textContent = message;
      document.body.appendChild(alertBox);
      setTimeout(() => {
        alertBox.classList.add('fade-out');
        setTimeout(() => alertBox.remove(), 500);
      }, 3000);
    }


    async function loadCart() {
      const token = localStorage.getItem('auth_token');
      if (!token) { document.getElementById("produk-container").innerHTML = "<div style='text-align:center;color:#888'>Silakan login</div>"; return; }

      // Check user role first
      try {
        const meResp = await API.authFetch('/auth/me');
        if (meResp.ok) {
          const user = await meResp.json();
          if (user.role !== 'pembeli') {
            let message = '';
            let redirectUrl = '';
            if (user.role === 'penjual') {
              message = 'Akun penjual tidak dapat melakukan checkout. Kelola produk Anda di dashboard.';
              redirectUrl = 'dashboard-penjual.html';
            } else if (user.role === 'kurir') {
              message = 'Akun kurir tidak dapat melakukan checkout. Fokus pada pengiriman pesanan.';
              redirectUrl = 'dashboard-kurir-new.html';
            } else if (user.role === 'admin') {
              message = 'Akun admin tidak dapat melakukan checkout. Kelola sistem di admin panel.';
              redirectUrl = 'admin.html';
            }
            document.getElementById("produk-container").innerHTML = `<div style='text-align:center;padding:40px'><p style='color:#ff4444;font-weight:bold;margin-bottom:20px'>${message}</p><button onclick="window.location.href='${redirectUrl}'" style='padding:10px 20px;background:#0077cc;color:white;border:none;border-radius:8px;cursor:pointer'>Ke Dashboard</button></div>`;
            return;
          }
        }
      } catch (e) {
        console.error('Failed to check user role', e);
      }

      try {
        const resp = await API.authFetch('/carts');
        if (!resp.ok) { document.getElementById("produk-container").innerHTML = "<div style='text-align:center;color:#888'>Gagal memuat keranjang</div>"; return; }
        const data = await resp.json();
        cartItems = (data.items || []).map(it => ({ id: it.produk_id, name: it.nama_produk, image: 'img/logo.png', price: Number(it.harga || 0), quantity: Number(it.jumlah || 0), item_id: it.item_id, stock: Number(it.stok || 0), penjual_nama: it.penjual_nama }));
        renderCartProducts();
      } catch { document.getElementById("produk-container").innerHTML = "<div style='text-align:center;color:#888'>Kesalahan jaringan</div>"; }
    }

    function renderCartProducts() {
      const container = document.getElementById("produk-container");
      container.innerHTML = "";
      let sellerSet = new Set();

      cartItems.forEach((item, index) => {
        const product = item;
        const sellerName = item.penjual_nama || "-";
        sellerSet.add(sellerName);

        const jumlah = item.quantity;
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="product-container">
            <div class="product-image-container">
              <img src="${item.image || 'img/default product.png'}" class="product-img" onerror="this.src='img/default product.png'" alt="${item.name}">
            </div>
            <div class="product-info-container">
              <h3>${item.name}</h3>
              <div style="color:#4b6a84;margin:4px 0 10px"><small>Penjual: ${sellerName}</small></div>
              <p style="color:#555; margin-top:-10px; margin-bottom:12px;">Hasil laut segar hasil tangkapan nelayan lokal. Cocok untuk berbagai jenis masakan khas Indonesia.</p>
              <strong>Rp. ${item.price.toLocaleString('id-ID')}</strong>
              <div class="qty-box">
                <button onclick="ubahJumlah(${index}, -1)">-</button>
                <span id="jumlah-${index}">${jumlah}</span> Kg
                <button onclick="ubahJumlah(${index}, 1)">+</button>
              </div>
            </div>
          </div>
        `;
        container.appendChild(card);
      });

      let sellerName = sellerSet.size === 1 ? Array.from(sellerSet)[0] : 'Multi Seller';
      document.getElementById('seller-name').textContent = sellerName;

      updateHarga();
    }

    async function ubahJumlah(index, change) {
      const item = cartItems[index];
      const newQty = item.quantity + change;
      if (newQty < 1) { showAlert('error', 'Minimal 1 kg'); return; }
      if (item.stock && newQty > parseInt(item.stock)) { showAlert('error', `Stok hanya tersedia ${item.stock} kg`); return; }
      try {
        const resp = await API.authFetch('/carts/items/' + item.item_id, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ jumlah: newQty }) });
        if (!resp.ok) { showAlert('error', 'Gagal mengubah jumlah'); return; }
        item.quantity = newQty;
        document.getElementById(`jumlah-${index}`).textContent = newQty;
        updateHarga();
      } catch { showAlert('error', 'Kesalahan jaringan'); }
    }

    function pilihKurir(nama, harga, event) {
      namaKurir = nama;
      ongkir = harga;

      document.querySelectorAll(".shipping-option").forEach(el => {
        el.classList.remove("active");
      });
      event.currentTarget.classList.add("active");

      updateHarga();
    }

    function updateHarga() {
      let totalProduk = 0;
      cartItems.forEach(item => {
        totalProduk += item.price * item.quantity;
      });

      const total = totalProduk + ongkir;

      document.getElementById("total-produk").textContent = `Rp. ${totalProduk.toLocaleString("id-ID")}`;
      document.getElementById("ongkir").textContent = `Rp. ${ongkir.toLocaleString("id-ID")}`;
      document.getElementById("total-harga").textContent = `Rp. ${total.toLocaleString("id-ID")}`;
    }

    async function checkout() {
      const token = localStorage.getItem('auth_token');
      if (!token) { showAlert('error', 'Silakan login'); return; }
      try {
        const resp = await API.authFetch('/orders/checkout', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ alamat_kirim: 'Alamat default' }) });
        if (!resp.ok) {
          try {
            const err = await resp.json();
            if (err && err.error === 'cart_empty') showAlert('error', 'Keranjang kosong');
            else if (err && err.error === 'insufficient_stock') showAlert('error', 'Stok kurang untuk salah satu produk');
            else if (err && err.error === 'product_missing') showAlert('error', 'Produk tidak ditemukan');
            else showAlert('error', 'Checkout gagal');
          } catch { showAlert('error', 'Checkout gagal'); }
          return;
        }
        const data = await resp.json();
        const metode = document.getElementById('pembayaran').value;
        const pay = await API.authFetch('/payments', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ pesanan_id: data.pesanan_id, metode }) });
        if (!pay.ok) { showAlert('error', 'Gagal membuat pembayaran'); return; }
        const pr = await pay.json();
        const totalProduk = cartItems.reduce((s, it) => s + (it.price * it.quantity), 0);
        const currentOrder = {
          produk: cartItems.map(it => ({ name: it.name, quantity: it.quantity, price: it.price, seller: it.penjual_nama || '-' })),
          pengiriman: { kurir: namaKurir, ongkos: ongkir },
          pembayaran: metode,
          total: totalProduk + ongkir,
          pesanan_id: data.pesanan_id,
          pembayaran_id: pr.pembayaran_id
        };
        try { localStorage.setItem('currentOrder', JSON.stringify(currentOrder)); } catch { }
        window.currentPaymentId = pr.pembayaran_id;
        const btn = document.getElementById('checkoutBtn');
        btn.textContent = 'Konfirmasi Pembayaran';
        btn.onclick = function () { confirmPaymentPrompt(window.currentPaymentId); };
        API.showModal({
          title: 'Pesanan Dibuat',
          message: 'Silakan lanjutkan pembayaran kemudian konfirmasi.',
          actions: [{ label: 'Oke', variant: 'primary', handler: API.hideModal }]
        });
      } catch { showAlert('error', 'Kesalahan jaringan'); }
    }
    function confirmPaymentPrompt(id) {
      API.showModal({
        title: 'Konfirmasi Pembayaran',
        message: 'Apakah pembayaran telah dilakukan? Sistem akan meminta autentikasi PIN untuk keamanan.',
        actions: [
          { label: 'Belum Bayar', variant: 'secondary', handler: API.hideModal },
          { label: 'Sudah Bayar, Lanjut Autentikasi', variant: 'primary', handler: function () { API.hideModal(); confirmPayment(id); } }
        ]
      });
    }

    async function confirmPayment(id) {
      // Redirect to payment authentication page like in dashboard
      try {
        const order = JSON.parse(localStorage.getItem('currentOrder') || '{}');
        const amount = order.total || 0;
        const method = order.pembayaran || 'Bank Transfer';
        const orderId = order.pesanan_id || '';
        
        const authUrl = `payment-auth.html?payment_id=${id}&order_id=${orderId}&amount=${amount}&method=${method}&from=checkout`;
        window.location.href = authUrl;
      } catch (e) {
        console.error('Error redirecting to payment auth:', e);
        showAlert('error', 'Gagal memproses pembayaran');
      }
    }

    async function loadUserAvatar() {
      const token = localStorage.getItem('auth_token');
      const img = document.getElementById('userAvatar');
      if (!img) return;
      if (!token) { img.src = 'img/pembeli.png'; return; }
      try {
        const resp = await API.authFetch('/auth/me');
        if (!resp.ok) { img.src = 'img/pembeli.png'; return; }
        const u = await resp.json();
        img.src = u.avatar_url ? (API.base + u.avatar_url) : 'img/pembeli.png';
        const nameEl = document.getElementById('userName');
        const subEl = document.getElementById('userSubtitle');
        if (nameEl) nameEl.textContent = u.nama || 'Akun';
        if (subEl) subEl.textContent = (u.email || '') + (u.role ? (' Â· ' + u.role) : '');
      } catch { img.src = 'img/pembeli.png'; }
    }

    document.addEventListener('DOMContentLoaded', function () {
      loadCart();
      loadUserAvatar();
    });
  </script>
</body>

</html>