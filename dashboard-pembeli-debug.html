<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pembeli - Debug</title>
    <script src="assets/js/api.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .stats { display: flex; gap: 20px; margin: 20px 0; }
        .stat { background: #f5f5f5; padding: 15px; border-radius: 8px; }
        .order { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .log { background: #e3f2fd; padding: 10px; margin: 5px 0; border-radius: 4px; font-size: 12px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e9; color: #2e7d32; }
    </style>
</head>
<body>
    <h1>Dashboard Pembeli - Debug Version</h1>
    
    <div id="welcome">
        <h2 id="welcomeName">Selamat Datang!</h2>
    </div>
    
    <div class="stats">
        <div class="stat">
            <div>Menunggu: <span id="statMenunggu">0</span></div>
        </div>
        <div class="stat">
            <div>Diproses: <span id="statDiproses">0</span></div>
        </div>
        <div class="stat">
            <div>Dikirim: <span id="statDikirim">0</span></div>
        </div>
        <div class="stat">
            <div>Selesai: <span id="statSelesai">0</span></div>
        </div>
    </div>
    
    <div id="ordersContainer">
        <p>Loading orders...</p>
    </div>
    
    <div id="logs">
        <h3>Debug Logs:</h3>
    </div>
    
    <script>
        const API_BASE = (window.API && window.API.base) || 'http://localhost:4000';
        let allOrders = [];
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById('logs').appendChild(div);
            console.log(message);
        }
        
        async function init() {
            log('üöÄ Dashboard debug init started');
            
            // Auto-login for testing
            try {
                log('üîÑ Auto-login for testing...');
                const loginResp = await fetch(API_BASE + '/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: 'pembeli@test.com', 
                        password: 'password123' 
                    })
                });
                
                if (!loginResp.ok) {
                    log(`‚ùå Auto-login failed: ${loginResp.status}`, 'error');
                    return;
                }
                
                const loginData = await loginResp.json();
                localStorage.setItem('auth_token', loginData.token);
                log('‚úÖ Auto-login successful', 'success');
                
                // Update welcome message
                document.getElementById('welcomeName').textContent = `Selamat Datang, ${loginData.user.nama}!`;
                
                // Load orders
                await loadOrders();
                
            } catch (e) {
                log(`‚ùå Init error: ${e.message}`, 'error');
            }
        }
        
        async function loadOrders() {
            log('üîÑ Loading orders...');
            try {
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    log('‚ùå No token found', 'error');
                    return;
                }

                const authHeaders = {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                };
                
                const resp = await fetch(API_BASE + '/orders/my-orders', { headers: authHeaders });
                log(`üì° API response status: ${resp.status}`);
                
                if (!resp.ok) {
                    const errorText = await resp.text();
                    log(`‚ùå API error: ${resp.status} - ${errorText}`, 'error');
                    return;
                }
                
                allOrders = await resp.json();
                log(`‚úÖ Orders loaded: ${allOrders.length} orders`, 'success');
                
                if (allOrders.length === 0) {
                    document.getElementById('ordersContainer').innerHTML = '<p>No orders found</p>';
                } else {
                    updateStats();
                    renderOrders();
                }
                
            } catch (e) {
                log(`‚ùå Error loading orders: ${e.message}`, 'error');
            }
        }
        
        function updateStats() {
            log('üìä Updating stats...');
            const stats = {
                pending: 0,
                menunggu: 0,
                dikemas: 0,
                diproses: 0,
                dikirim: 0,
                selesai: 0,
                dibatalkan: 0,
                empty: 0
            };

            allOrders.forEach(order => {
                const status = order.status || order.status_pesanan || '';
                if (status === '') {
                    stats.empty++;
                    stats.menunggu++;
                } else if (stats.hasOwnProperty(status)) {
                    stats[status]++;
                }
            });

            const menungguTotal = stats.pending + stats.menunggu;
            const diprosesTotal = stats.dikemas + stats.diproses;
            
            document.getElementById('statMenunggu').textContent = menungguTotal;
            document.getElementById('statDiproses').textContent = diprosesTotal;
            document.getElementById('statDikirim').textContent = stats.dikirim;
            document.getElementById('statSelesai').textContent = stats.selesai;
            
            log(`‚úÖ Stats updated - Menunggu: ${menungguTotal}, Diproses: ${diprosesTotal}, Dikirim: ${stats.dikirim}, Selesai: ${stats.selesai}`, 'success');
        }
        
        function renderOrders() {
            log('üé® Rendering orders...');
            const container = document.getElementById('ordersContainer');
            
            container.innerHTML = allOrders.map(order => {
                const status = order.status || order.status_pesanan || '';
                const normalizedStatus = status === '' ? 'menunggu' : status;
                const itemsText = order.items ? order.items.map(item => `${item.nama_produk} (${item.jumlah}x)`).join(', ') : 'No items';
                
                return `
                    <div class="order">
                        <strong>Order #${order.pesanan_id}</strong> - Status: ${normalizedStatus}<br>
                        <small>Date: ${new Date(order.tanggal_pesanan || order.created_at).toLocaleDateString()}</small><br>
                        <small>Items: ${itemsText}</small><br>
                        <strong>Total: Rp ${Number(order.total_harga).toLocaleString('id-ID')}</strong>
                    </div>
                `;
            }).join('');
            
            log(`‚úÖ Successfully rendered ${allOrders.length} orders`, 'success');
        }
        
        // Start when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>