<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Penjual - Lautan Kita</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #d6d9ff;
            color: #07304A;
        }

        .header {
            background: #0077B6;
            color: white;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: white;
            color: #0077B6;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .btn-success {
            background: #10B981;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .welcome-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .welcome-card h2 {
            color: #0077B6;
            margin-bottom: 8px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .stat-card .icon {
            font-size: 32px;
            color: #0077B6;
            margin-bottom: 12px;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: 700;
            color: #07304A;
        }

        .stat-card .label {
            color: #64748B;
            font-size: 14px;
            margin-top: 4px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 600;
            color: #64748B;
        }

        .tab.active {
            color: #0077B6;
            border-bottom-color: #0077B6;
        }

        .tab:hover {
            color: #0077B6;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 16px;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .product-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            transition: all 0.3s;
        }

        .product-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .product-img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .product-name {
            font-weight: 700;
            color: #07304A;
            margin-bottom: 8px;
        }

        .product-price {
            color: #0077B6;
            font-weight: 600;
            font-size: 18px;
        }

        .product-stock {
            color: #64748B;
            font-size: 14px;
            margin-top: 4px;
        }

        .product-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            flex: 1;
        }

        .action-btn.edit {
            background: #0077B6;
            color: white;
        }

        .action-btn.delete {
            background: #EF4444;
            color: white;
        }

        .order-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s;
        }

        .order-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .order-item:last-child {
            margin-bottom: 0;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .order-id {
            font-weight: 700;
            color: #0077B6;
        }

        .order-details {
            color: #64748B;
            font-size: 14px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #64748B;
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 20px 0;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            margin: auto;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #0077B6;
            margin-bottom: 16px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #07304A;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .preview-image {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            margin-top: 8px;
        }

        .filter-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .filter-bar input,
        .filter-bar select {
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            flex: 1;
            min-width: 200px;
        }

        .product-table {
            width: 100%;
            border-collapse: collapse;
        }

        .product-table thead {
            background: #f8f9fa;
        }

        .product-table th {
            padding: 14px;
            text-align: left;
            font-weight: 700;
            color: #07304A;
            border-bottom: 2px solid #e5e7eb;
        }

        .product-table td {
            padding: 12px 14px;
            border-bottom: 1px solid #f0f0f0;
        }

        .product-table tbody tr:hover {
            background: #f9f9f9;
        }

        .product-thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }

        .product-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .view-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .view-btn {
            padding: 8px 16px;
            border: 1px solid #cbd5e1;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .view-btn.active {
            background: #0077B6;
            color: white;
            border-color: #0077B6;
        }

        .rating-stars {
            display: flex;
            gap: 8px;
            margin: 12px 0;
        }

        .rating-stars i {
            font-size: 28px;
            cursor: pointer;
            color: #E5E7EB;
            transition: color 0.2s;
        }

        .rating-stars i.active,
        .rating-stars i:hover {
            color: #F59E0B;
        }
    </style>
    <script src="assets/js/api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body>
    <div class="header">
        <div class="header-content">
            <h1><i class="fas fa-store"></i> Dashboard Penjual</h1>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="window.location.href='home_final.html'">
                    <i class="fas fa-home"></i> Beranda
                </button>
                <button class="btn btn-success" onclick="openAddProductModal()">
                    <i class="fas fa-plus"></i> Tambah Produk
                </button>
                <button class="btn btn-primary" onclick="window.location.href='views/profil.html'">
                    <i class="fas fa-user"></i> Profil
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="welcome-card">
            <h2 id="welcomeName">Selamat Datang!</h2>
            <p style="color: #64748B;">Kelola produk dan pantau pesanan masuk di sini.</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="icon"><i class="fas fa-box"></i></div>
                <div class="value" id="statProducts">0</div>
                <div class="label">Total Produk</div>
            </div>
            <div class="stat-card">
                <div class="icon"><i class="fas fa-check-circle"></i></div>
                <div class="value" id="statActiveProducts">0</div>
                <div class="label">Produk Aktif</div>
            </div>
            <div class="stat-card">
                <div class="icon"><i class="fas fa-shopping-cart"></i></div>
                <div class="value" id="statOrders">0</div>
                <div class="label">Pesanan Masuk</div>
            </div>
            <div class="stat-card">
                <div class="icon"><i class="fas fa-money-bill-wave"></i></div>
                <div class="value" id="statRevenue">Rp 0</div>
                <div class="label">Total Pendapatan</div>
            </div>
            <div class="stat-card">
                <div class="icon"><i class="fas fa-star"></i></div>
                <div class="value" id="statRating">0.0</div>
                <div class="label">Rating Toko</div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('products')">Produk Saya</div>
            <div class="tab" onclick="showTab('orders')">Pesanan Masuk</div>
            <div class="tab" onclick="showTab('report')">Laporan Penjualan</div>
            <div class="tab" onclick="showTab('reviews')">Ulasan Pembeli</div>
        </div>

        <div class="card" id="productsView">
            <div class="view-toggle">
                <button class="view-btn active" onclick="setProductView('grid')">
                    <i class="fas fa-th"></i> Grid
                </button>
                <button class="view-btn" onclick="setProductView('table')">
                    <i class="fas fa-list"></i> Tabel
                </button>
            </div>

            <div class="filter-bar">
                <input type="text" id="searchProduct" placeholder="Cari produk..." onkeyup="filterProducts()">
                <select id="filterStatus" onchange="filterProducts()">
                    <option value="">Semua Status</option>
                    <option value="aktif">Aktif</option>
                    <option value="nonaktif">Nonaktif</option>
                </select>
            </div>

            <div class="product-grid" id="productsContainer">
                <div class="empty-state">
                    <i class="fas fa-box"></i>
                    <p>Memuat produk...</p>
                </div>
            </div>

            <div id="productsTableContainer" style="display:none;">
                <table class="product-table">
                    <thead>
                        <tr>
                            <th>Produk</th>
                            <th>Kategori</th>
                            <th>Harga / Satuan</th>
                            <th>Stok</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        <tr>
                            <td colspan="6" style="text-align: center;">Memuat produk...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card" id="ordersView" style="display:none;">
            <div class="filter-bar" style="margin-bottom: 20px;">
                <select id="filterOrderStatus" onchange="filterOrders()">
                    <option value="">Semua Status</option>
                    <option value="menunggu">Pesanan Baru</option>
                    <option value="pending">Pembayaran Dikonfirmasi</option>
                    <option value="dikemas">Sedang Dikemas</option>
                    <option value="dikirim">Dalam Pengiriman</option>
                    <option value="selesai">Selesai</option>
                    <option value="dibatalkan">Dibatalkan</option>
                </select>
            </div>
            <div id="ordersContainer">
                <div class="empty-state">
                    <i class="fas fa-shopping-cart"></i>
                    <p>Memuat pesanan...</p>
                </div>
            </div>
        </div>

        <!-- Laporan Penjualan View -->
        <div class="card" id="reportView" style="display:none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #0077B6; margin: 0;"><i class="fas fa-chart-bar"></i> Laporan Penjualan</h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="exportLaporanCSV()" style="background: #10B981;">
                        <i class="fas fa-file-csv"></i> Export CSV
                    </button>
                    <button class="btn btn-primary" onclick="exportLaporanPDF()" style="background: #EF4444;">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                </div>
            </div>

            <!-- Filter Section -->
            <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="margin-bottom: 12px; color: #0077B6;"><i class="fas fa-filter"></i> Filter Laporan</h4>
                <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
                    <div>
                        <label style="font-weight: 600; margin-bottom: 5px; display: block; font-size: 13px;">Bulan:</label>
                        <select id="reportFilterMonth" class="filter-bar" style="padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; min-width: 150px;">
                            <option value="">Semua Bulan</option>
                            <option value="1">Januari</option>
                            <option value="2">Februari</option>
                            <option value="3">Maret</option>
                            <option value="4">April</option>
                            <option value="5">Mei</option>
                            <option value="6">Juni</option>
                            <option value="7">Juli</option>
                            <option value="8">Agustus</option>
                            <option value="9">September</option>
                            <option value="10">Oktober</option>
                            <option value="11">November</option>
                            <option value="12">Desember</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-weight: 600; margin-bottom: 5px; display: block; font-size: 13px;">Tahun:</label>
                        <select id="reportFilterYear" class="filter-bar" style="padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; min-width: 120px;">
                            <option value="">Semua Tahun</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="loadSalesReportFiltered()">
                        <i class="fas fa-search"></i> Terapkan Filter
                    </button>
                    <button class="btn btn-secondary" onclick="resetReportFilter()">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                </div>
                <!-- Period Display -->
                <div id="reportPeriodDisplay" style="margin-top: 12px; padding: 10px; background: #DBEAFE; border-radius: 8px; display: none;">
                    <i class="fas fa-info-circle" style="color: #0077B6;"></i>
                    <span id="reportPeriodText" style="font-weight: 500; color: #1E40AF;"></span>
                </div>
            </div>

            <!-- Ringkasan Laba Rugi -->
            <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                <h4 style="margin-bottom: 16px; color: #0077B6;"><i class="fas fa-chart-pie"></i> Laporan Laba Rugi</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                    <div style="background: linear-gradient(135deg, #0077B6, #00A8E8); padding: 16px; border-radius: 10px; color: white;">
                        <div style="font-size: 13px; opacity: 0.9;"><i class="fas fa-coins"></i> Total Pendapatan</div>
                        <div id="reportTotalPendapatan" style="font-size: 22px; font-weight: 700; margin-top: 8px;">Rp 0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #EF4444, #F87171); padding: 16px; border-radius: 10px; color: white;">
                        <div style="font-size: 13px; opacity: 0.9;"><i class="fas fa-box"></i> Total Modal (HPP)</div>
                        <div id="reportTotalModal" style="font-size: 22px; font-weight: 700; margin-top: 8px;">Rp 0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #10B981, #34D399); padding: 16px; border-radius: 10px; color: white;">
                        <div style="font-size: 13px; opacity: 0.9;"><i class="fas fa-chart-line"></i> Laba Kotor</div>
                        <div id="reportLabaKotor" style="font-size: 22px; font-weight: 700; margin-top: 8px;">Rp 0</div>
                        <div id="reportMarginPersen" style="font-size: 12px; opacity: 0.9; margin-top: 4px;">Margin: 0%</div>
                    </div>
                </div>
            </div>

            <div class="stats" style="margin-bottom: 24px;">
                <div class="stat-card" style="background: linear-gradient(135deg, #8B5CF6, #A78BFA);">
                    <div class="icon" style="color: white;"><i class="fas fa-receipt"></i></div>
                    <div class="value" id="reportTotalTransaksi" style="color: white;">0</div>
                    <div class="label" style="color: rgba(255,255,255,0.8);">Total Transaksi</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #F59E0B, #FBBF24);">
                    <div class="icon" style="color: white;"><i class="fas fa-shopping-bag"></i></div>
                    <div class="value" id="reportTotalTerjual" style="color: white;">0</div>
                    <div class="label" style="color: rgba(255,255,255,0.8);">Total Produk Terjual</div>
                </div>
            </div>

            <h4 style="margin-bottom: 16px; color: #07304A;"><i class="fas fa-box"></i> Penjualan per Produk</h4>
            <div id="productSalesContainer">
                <div class="empty-state">
                    <i class="fas fa-chart-line"></i>
                    <p>Memuat laporan...</p>
                </div>
            </div>

            <h4 style="margin: 24px 0 16px; color: #07304A;"><i class="fas fa-calendar-alt"></i> Penjualan Bulanan</h4>
            <div id="monthlySalesContainer">
                <div class="empty-state">
                    <i class="fas fa-calendar"></i>
                    <p>Memuat data bulanan...</p>
                </div>
            </div>
        </div>

        <!-- Ulasan Pembeli View -->
        <div class="card" id="reviewsView" style="display:none;">
            <h3 style="margin-bottom: 20px; color: #0077B6;"><i class="fas fa-star"></i> Ulasan dari Pembeli</h3>
            <div id="reviewsContainer">
                <div class="empty-state">
                    <i class="fas fa-comments"></i>
                    <p>Memuat ulasan...</p>
                </div>
            </div>
        </div>

    </div>

    <!-- Modal Tambah/Edit Produk -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">Tambah Produk Baru</div>
            <form id="productForm">
                <div class="form-group">
                    <label>Nama Produk *</label>
                    <input type="text" id="productName" placeholder="Contoh: Ikan Tongkol Segar" required>
                </div>
                <div class="form-group">
                    <label>Kategori</label>
                    <select id="productCategory">
                        <option value="">-- Pilih Kategori --</option>
                        <option value="ikan">Ikan</option>
                        <option value="udang">Udang</option>
                        <option value="cumi">Cumi-cumi</option>
                        <option value="kerang">Kerang</option>
                        <option value="lainnya">Lainnya</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Deskripsi</label>
                    <textarea id="productDesc"
                        placeholder="Contoh: Ikan tongkol segar hasil tangkapan pagi hari, cocok untuk gulai atau balado."></textarea>
                </div>
                <div class="form-group">
                    <label>Harga per Satuan (Rp) *</label>
                    <input type="number" id="productPrice" placeholder="35000" required min="0">
                </div>
                <div class="form-group">
                    <label>Satuan *</label>
                    <select id="productUnit" required>
                        <option value="kg">Kilogram (kg)</option>
                        <option value="ons">Ons</option>
                        <option value="ikat">Ikat</option>
                        <option value="pcs">Pcs</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Stok Tersedia *</label>
                    <input type="number" id="productStock" placeholder="20" required min="0">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="productStatus">
                        <option value="aktif">Aktif (ditampilkan)</option>
                        <option value="nonaktif">Nonaktif (tidak ditampilkan)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Foto Produk</label>
                    <input type="file" id="productImage" accept="image/*" onchange="previewImage(event)">
                    <small style="color: #64748B; display: block; margin-top: 4px;">Format: JPG/PNG, maks 2MB</small>
                </div>
                <div class="form-group">
                    <label>Preview Foto</label>
                    <img id="previewFoto" src="img/logo.png" alt="Preview" class="preview-image">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = (window.API && window.API.base) || 'http://localhost:4000';
        let myProducts = [];
        let myOrders = [];
        let currentView = 'products';
        let editingProductId = null;
        let productViewMode = 'grid';

        async function init() {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const resp = await API.authFetch('/auth/me');
                if (resp.ok) {
                    const user = await resp.json();
                    if (user.role !== 'penjual') {
                        API.showModal({
                            title: 'Akses Ditolak',
                            message: 'Halaman ini hanya untuk penjual.',
                            actions: [{ label: 'OK', variant: 'primary', handler: () => { window.location.href = 'home_final.html'; } }]
                        });
                        return;
                    }
                    document.getElementById('welcomeName').textContent = `Selamat Datang, ${user.nama}!`;
                }
            } catch (e) {
                console.error('Failed to load user:', e);
            }

            await loadProducts();
            await loadOrders();
        }

        async function loadProducts() {
            try {
                const resp = await API.authFetch('/penjual/produk');
                if (!resp.ok) throw new Error('Failed to load products');
                myProducts = await resp.json();
                document.getElementById('statProducts').textContent = myProducts.length;

                // Count active products
                const activeCount = myProducts.filter(p => p.status === 'aktif').length;
                document.getElementById('statActiveProducts').textContent = activeCount;

                renderProducts();
            } catch (e) {
                document.getElementById('productsContainer').innerHTML = `
          <div class="empty-state">
            <i class="fas fa-exclamation-circle"></i>
            <p>Gagal memuat produk.</p>
          </div>
        `;
            }
        }

        async function loadOrders() {
            try {
                const resp = await API.authFetch('/penjual/orders');
                if (!resp.ok) throw new Error('Failed to load orders');
                myOrders = await resp.json();
                document.getElementById('statOrders').textContent = myOrders.length;
                renderOrders();

                // Load sales report for stats
                loadSalesStats();
            } catch (e) {
                document.getElementById('ordersContainer').innerHTML = `
          <div class="empty-state">
            <i class="fas fa-exclamation-circle"></i>
            <p>Gagal memuat pesanan.</p>
          </div>
        `;
            }
        }

        async function loadSalesStats() {
            try {
                const resp = await API.authFetch('/penjual/laporan');
                if (resp.ok) {
                    const data = await resp.json();
                    document.getElementById('statRevenue').textContent = `Rp ${Number(data.overall.total_pendapatan).toLocaleString('id-ID')}`;
                    document.getElementById('statRating').textContent = Number(data.rating.avg_rating).toFixed(1);
                }
            } catch (e) {
                console.log('Failed to load sales stats');
            }
        }

        function showTab(view) {
            currentView = view;
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('productsView').style.display = view === 'products' ? 'block' : 'none';
            document.getElementById('ordersView').style.display = view === 'orders' ? 'block' : 'none';
            document.getElementById('reportView').style.display = view === 'report' ? 'block' : 'none';
            document.getElementById('reviewsView').style.display = view === 'reviews' ? 'block' : 'none';

            if (view === 'report') loadSalesReport();
            if (view === 'reviews') loadSellerReviews();
        }

        function renderProducts() {
            if (productViewMode === 'grid') {
                renderProductsGrid();
            } else {
                renderProductsTable();
            }
        }

        function renderProductsGrid() {
            const container = document.getElementById('productsContainer');

            if (myProducts.length === 0) {
                container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-box"></i>
            <p>Belum ada produk. Klik "Tambah Produk" untuk mulai berjualan.</p>
          </div>
        `;
                return;
            }

            container.innerHTML = myProducts.map(product => `
        <div class="product-card">
          <img src="${product.photo_url ? (API_BASE + product.photo_url) : 'img/logo.png'}" 
               alt="${product.nama_produk}" class="product-img" 
               onerror="this.src='img/logo.png'">
          <div class="product-name">${product.nama_produk}</div>
          <div class="product-price">Rp ${Number(product.harga).toLocaleString('id-ID')}/kg</div>
          <div class="product-stock">Stok: ${product.stok} kg</div>
          <div class="product-stock" style="color: ${product.status === 'aktif' ? '#10B981' : '#EF4444'}">
            Status: ${product.status === 'aktif' ? 'Aktif' : 'Nonaktif'}
          </div>
          <div class="product-actions">
            <button class="action-btn edit" onclick="editProduct(${product.produk_id})">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button class="action-btn delete" onclick="deleteProduct(${product.produk_id})">
              <i class="fas fa-trash"></i> Hapus
            </button>
            <button class="action-btn" onclick="checkProductOrders(${product.produk_id})" style="background: #6B7280; color: white; font-size: 12px; padding: 6px 8px;">
              <i class="fas fa-info-circle"></i> Info
            </button>
          </div>
        </div>
      `).join('');
        }

        function renderProductsTable() {
            const tbody = document.getElementById('productsTableBody');

            if (myProducts.length === 0) {
                tbody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center;">
              Belum ada produk. Klik "Tambah Produk" untuk mulai berjualan.
            </td>
          </tr>
        `;
                return;
            }

            tbody.innerHTML = myProducts.map(product => `
        <tr>
          <td>
            <div class="product-info">
              <img src="${product.photo_url ? (API_BASE + product.photo_url) : 'img/logo.png'}" 
                   alt="${product.nama_produk}" class="product-thumb" 
                   onerror="this.src='img/logo.png'">
              <div>
                <div style="font-weight: 600;">${product.nama_produk}</div>
                <small style="color: #64748B;">ID: ${product.produk_id}</small>
              </div>
            </div>
          </td>
          <td>${product.kategori || '-'}</td>
          <td>Rp ${Number(product.harga).toLocaleString('id-ID')} / kg</td>
          <td>${product.stok}</td>
          <td>
            <span class="badge ${product.status === 'aktif' ? 'badge-success' : 'badge-warning'}">
              ${product.status === 'aktif' ? 'Aktif' : 'Nonaktif'}
            </span>
          </td>
          <td>
            <button class="action-btn edit" onclick="editProduct(${product.produk_id})" style="margin-right: 4px;">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button class="action-btn delete" onclick="deleteProduct(${product.produk_id})" style="margin-right: 4px;">
              <i class="fas fa-trash"></i> Hapus
            </button>
            <button class="action-btn" onclick="checkProductOrders(${product.produk_id})" style="background: #6B7280; color: white; font-size: 12px; padding: 6px 8px;">
              <i class="fas fa-info-circle"></i>
            </button>
          </td>
        </tr>
      `).join('');
        }

        function setProductView(mode) {
            productViewMode = mode;

            // Update button states
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.view-btn').classList.add('active');

            // Toggle containers
            if (mode === 'grid') {
                document.getElementById('productsContainer').style.display = 'grid';
                document.getElementById('productsTableContainer').style.display = 'none';
            } else {
                document.getElementById('productsContainer').style.display = 'none';
                document.getElementById('productsTableContainer').style.display = 'block';
            }

            renderProducts();
        }

        function filterProducts() {
            const searchTerm = document.getElementById('searchProduct').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;

            const filtered = myProducts.filter(product => {
                const matchSearch = product.nama_produk.toLowerCase().includes(searchTerm);
                const matchStatus = !statusFilter || product.status === statusFilter;
                return matchSearch && matchStatus;
            });

            // Temporarily replace myProducts for rendering
            const originalProducts = myProducts;
            myProducts = filtered;
            renderProducts();
            myProducts = originalProducts;
        }

        function renderOrders() {
            const container = document.getElementById('ordersContainer');
            const filterStatus = document.getElementById('filterOrderStatus')?.value || '';

            if (myOrders.length === 0) {
                container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-shopping-cart"></i>
            <p>Belum ada pesanan masuk.</p>
          </div>
        `;
                return;
            }

            // Group orders by pesanan_id
            const groupedOrders = {};
            myOrders.forEach(order => {
                if (!groupedOrders[order.pesanan_id]) {
                    groupedOrders[order.pesanan_id] = {
                        pesanan_id: order.pesanan_id,
                        status_pesanan: order.status_pesanan,
                        created_at: order.created_at,
                        pembeli_id: order.pembeli_id,
                        total: 0,
                        items: []
                    };
                }
                groupedOrders[order.pesanan_id].items.push(order);
                groupedOrders[order.pesanan_id].total += Number(order.subtotal || 0);
            });

            // Filter by status
            let filtered = Object.values(groupedOrders);
            if (filterStatus) {
                filtered = filtered.filter(o => o.status_pesanan === filterStatus);
            }

            if (filtered.length === 0) {
                container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-filter"></i>
            <p>Tidak ada pesanan dengan status ini.</p>
          </div>
        `;
                return;
            }

            const statusMap = {
                '': { label: 'Pesanan Baru', color: '#F59E0B', icon: 'shopping-cart' },
                'menunggu': { label: 'Pesanan Baru', color: '#F59E0B', icon: 'shopping-cart' },
                'pending': { label: 'Pembayaran Dikonfirmasi', color: '#10B981', icon: 'check' },
                'dikemas': { label: 'Sedang Dikemas', color: '#3B82F6', icon: 'box' },
                'dikirim': { label: 'Dalam Pengiriman', color: '#8B5CF6', icon: 'truck' },
                'selesai': { label: 'Selesai', color: '#10B981', icon: 'check-circle' },
                'dibatalkan': { label: 'Dibatalkan', color: '#EF4444', icon: 'times-circle' }
            };

            container.innerHTML = filtered.map(order => {
                const orderStatus = order.status_pesanan || '';
                const status = statusMap[orderStatus] || statusMap['menunggu'];
                return `
        <div class="order-item" style="border-left: 4px solid ${status.color};">
          <div class="order-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <div>
              <span class="order-id" style="font-size: 18px; font-weight: 700; color: #0077B6;">
                Pesanan #${order.pesanan_id}
              </span>
              <span style="margin-left: 12px; color: #64748B; font-size: 14px;">
                <i class="fas fa-calendar"></i> ${new Date(order.created_at).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' })}
              </span>
            </div>
            <div style="padding: 6px 12px; background: ${status.color}20; color: ${status.color}; border-radius: 20px; font-weight: 600; font-size: 14px;">
              <i class="fas fa-${status.icon}"></i> ${status.label}
            </div>
          </div>
          
          <div class="order-details" style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
            <h4 style="margin-bottom: 12px; color: #07304A;">Produk yang Dipesan:</h4>
            ${order.items.map(item => `
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding: 8px; background: white; border-radius: 6px;">
                <div>
                  <strong style="color: #07304A;">${item.nama_produk}</strong>
                  <div style="font-size: 14px; color: #64748B; margin-top: 4px;">
                    ${item.jumlah} kg Ã— Rp ${Number(item.subtotal / item.jumlah).toLocaleString('id-ID')}
                  </div>
                </div>
                <div style="font-weight: 600; color: #0077B6;">
                  Rp ${Number(item.subtotal).toLocaleString('id-ID')}
                </div>
              </div>
            `).join('')}
            <div style="display: flex; justify-content: space-between; margin-top: 12px; padding-top: 12px; border-top: 2px solid #e5e7eb; font-size: 16px; font-weight: 700;">
              <span style="color: #07304A;">Total:</span>
              <span style="color: #0077B6;">Rp ${order.total.toLocaleString('id-ID')}</span>
            </div>
          </div>

          ${getOrderActionHtml(order)}
        </div>
      `;
            }).join('');
        }

        function filterOrders() {
            renderOrders();
        }

        function getOrderActionHtml(order) {
            const status = order.status_pesanan;
            console.log('Order status:', order.pesanan_id, status);

            // Handle empty status, pending, or menunggu - all can be packed
            if (status === 'pending' || status === 'menunggu' || status === '' || !status) {
                return `
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-success" onclick="packOrder(${order.pesanan_id})" style="flex: 1;">
                            <i class="fas fa-box"></i> Kemas Pesanan
                        </button>
                    </div>
                `;
            } else if (status === 'dikemas') {
                return `
                    <div style="padding: 12px; background: #DBEAFE; border-radius: 8px; color: #1E40AF;">
                        <i class="fas fa-info-circle"></i> Pesanan sedang menunggu kurir untuk diambil
                    </div>
                `;
            } else if (status === 'dikirim') {
                return `
                    <div style="padding: 12px; background: #E0E7FF; border-radius: 8px; color: #4338CA;">
                        <i class="fas fa-truck"></i> Pesanan sedang dalam pengiriman
                    </div>
                `;
            } else if (status === 'selesai') {
                return `
                    <div style="padding: 12px; background: #D1FAE5; border-radius: 8px; color: #065F46;">
                        <i class="fas fa-check-circle"></i> Pesanan telah selesai
                    </div>
                `;
            } else if (status === 'dibatalkan') {
                return `
                    <div style="padding: 12px; background: #FEE2E2; border-radius: 8px; color: #991B1B;">
                        <i class="fas fa-times-circle"></i> Pesanan dibatalkan
                    </div>
                `;
            }
            return '';
        }

        async function packOrder(orderId) {
            if (!confirm('Konfirmasi bahwa pesanan sudah dikemas dan siap untuk dikirim?')) return;

            try {
                const resp = await API.authFetch(`/orders/${orderId}/pack`, {
                    method: 'PATCH'
                });

                if (resp.ok) {
                    API.showModal({
                        title: 'Berhasil',
                        message: 'Pesanan berhasil dikemas! Menunggu kurir untuk mengambil.',
                        actions: [{ label: 'OK', variant: 'primary', handler: () => { API.hideModal(); loadOrders(); } }]
                    });
                } else {
                    const error = await resp.json();
                    throw new Error(error.error || 'Gagal mengemas pesanan');
                }
            } catch (e) {
                API.showModal({ title: 'Error', message: e.message || 'Gagal mengemas pesanan' });
            }
        }

        function openAddProductModal() {
            editingProductId = null;
            document.getElementById('modalTitle').textContent = 'Tambah Produk Baru';
            document.getElementById('productForm').reset();
            document.getElementById('productModal').classList.add('active');
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
        }

        async function editProduct(productId) {
            const product = myProducts.find(p => p.produk_id === productId);
            if (!product) return;

            editingProductId = productId;
            document.getElementById('modalTitle').textContent = 'Edit Produk';
            document.getElementById('productName').value = product.nama_produk;
            document.getElementById('productCategory').value = product.kategori || '';
            document.getElementById('productDesc').value = product.deskripsi || '';
            document.getElementById('productPrice').value = product.harga;
            document.getElementById('productUnit').value = product.satuan || 'kg';
            document.getElementById('productStock').value = product.stok;
            document.getElementById('productStatus').value = product.status || 'aktif';

            // Set preview image
            if (product.photo_url) {
                document.getElementById('previewFoto').src = API_BASE + product.photo_url;
            } else {
                document.getElementById('previewFoto').src = 'img/logo.png';
            }

            document.getElementById('productModal').classList.add('active');
        }

        function previewImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('previewFoto').src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('productName').value.trim();
            const category = document.getElementById('productCategory').value.trim();
            const desc = document.getElementById('productDesc').value.trim();
            const price = Number(document.getElementById('productPrice').value);
            const unit = document.getElementById('productUnit').value;
            const stock = Number(document.getElementById('productStock').value);
            const status = document.getElementById('productStatus').value;
            const imageFile = document.getElementById('productImage').files[0];

            let imageBase64 = null;
            if (imageFile) {
                imageBase64 = await fileToBase64(imageFile);
            }

            // Validate required fields
            if (!name || name.length < 2) {
                API.showModal({ title: 'Error', message: 'Nama produk minimal 2 karakter.' });
                return;
            }
            if (!price || price <= 0) {
                API.showModal({ title: 'Error', message: 'Harga harus lebih dari 0.' });
                return;
            }

            const data = {
                nama_produk: name,
                kategori: category || undefined,
                deskripsi: desc || undefined,
                harga: parseFloat(price),
                satuan: unit || 'kg',
                stok: parseInt(stock) || 0,
                status: status || 'aktif'
            };

            // Only include image if one was selected
            if (imageBase64) {
                data.image = imageBase64;
            }

            try {
                console.log('Submitting product data:', data);

                let resp;
                if (editingProductId) {
                    console.log('Updating product ID:', editingProductId);
                    resp = await API.authFetch(`/penjual/produk/${editingProductId}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    console.log('Creating new product');
                    resp = await API.authFetch('/penjual/produk', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }

                if (resp.ok) {
                    closeProductModal();
                    API.showModal({
                        title: 'Berhasil',
                        message: editingProductId ? 'Produk berhasil diperbarui!' : 'Produk berhasil ditambahkan!',
                        actions: [{ label: 'OK', variant: 'primary', handler: () => { API.hideModal(); loadProducts(); } }]
                    });
                } else {
                    const error = await resp.json();
                    console.error('Product save error:', error);

                    let errorMessage = 'Gagal menyimpan produk.';
                    if (error.details && error.details.length > 0) {
                        errorMessage += '\n\nDetail error:\n';
                        error.details.forEach(detail => {
                            errorMessage += `- ${detail.msg} (${detail.param})\n`;
                        });
                    } else if (error.message) {
                        errorMessage += '\n\n' + error.message;
                    }

                    API.showModal({
                        title: 'Error',
                        message: errorMessage
                    });
                }
            } catch (e) {
                API.showModal({ title: 'Error', message: 'Terjadi kesalahan jaringan.' });
            }
        });

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function deleteProduct(productId) {
            const product = myProducts.find(p => p.produk_id === productId);
            if (!product) return;

            API.showModal({
                title: 'Hapus Produk',
                message: `Apakah Anda yakin ingin menghapus produk "${product.nama_produk}"? Tindakan ini tidak dapat dibatalkan.`,
                actions: [
                    { label: 'Batal', variant: 'secondary', handler: API.hideModal },
                    {
                        label: 'Ya, Hapus',
                        variant: 'primary',
                        handler: async () => {
                            API.hideModal();
                            try {
                                const resp = await API.authFetch(`/penjual/produk/${productId}`, {
                                    method: 'DELETE'
                                });

                                if (resp.ok) {
                                    API.showModal({
                                        title: 'Berhasil',
                                        message: 'Produk berhasil dihapus!',
                                        actions: [{
                                            label: 'OK',
                                            variant: 'primary',
                                            handler: () => {
                                                API.hideModal();
                                                loadProducts();
                                            }
                                        }]
                                    });
                                } else {
                                    const error = await resp.json();
                                    let errorMessage = error.message || 'Gagal menghapus produk.';

                                    if (error.error === 'product_in_pending_orders') {
                                        errorMessage += '\n\nTip: Anda bisa mengubah status produk menjadi "Nonaktif" untuk menyembunyikannya dari pembeli.';
                                    }

                                    API.showModal({
                                        title: 'Tidak Dapat Menghapus Produk',
                                        message: errorMessage
                                    });
                                }
                            } catch (e) {
                                API.showModal({
                                    title: 'Error',
                                    message: 'Terjadi kesalahan jaringan.'
                                });
                            }
                        }
                    }
                ]
            });
        }

        async function checkProductOrders(productId) {
            try {
                const resp = await API.authFetch(`/penjual/produk/${productId}/orders`);
                if (resp.ok) {
                    const data = await resp.json();
                    const statusMap = {
                        'pending': 'Menunggu Pembayaran',
                        'menunggu': 'Menunggu Konfirmasi',
                        'diproses': 'Sedang Diproses',
                        'dikemas': 'Sedang Dikemas',
                        'dikirim': 'Dalam Pengiriman',
                        'selesai': 'Selesai',
                        'dibatalkan': 'Dibatalkan'
                    };

                    let message = `Informasi Pesanan Produk:\n\n`;
                    message += `Total pesanan: ${data.total_orders}\n`;
                    message += `Pesanan aktif: ${data.pending_orders}\n\n`;

                    if (data.orders.length > 0) {
                        message += `Riwayat pesanan:\n`;
                        data.orders.slice(0, 5).forEach(order => {
                            const status = statusMap[order.status_pesanan] || order.status_pesanan;
                            const date = new Date(order.created_at).toLocaleDateString('id-ID');
                            message += `â€¢ Pesanan #${order.pesanan_id} - ${status} (${date})\n`;
                        });

                        if (data.orders.length > 5) {
                            message += `... dan ${data.orders.length - 5} pesanan lainnya\n`;
                        }
                    }

                    if (data.pending_orders > 0) {
                        message += `\nâš ï¸ Produk tidak dapat dihapus karena masih ada pesanan aktif.`;
                    } else {
                        message += `\nâœ… Produk dapat dihapus (tidak ada pesanan aktif).`;
                    }

                    API.showModal({
                        title: 'Info Pesanan Produk',
                        message: message
                    });
                } else {
                    API.showModal({ title: 'Error', message: 'Gagal memuat info pesanan.' });
                }
            } catch (e) {
                API.showModal({ title: 'Error', message: 'Terjadi kesalahan jaringan.' });
            }
        }

        // Sales report data storage
        let salesReportData = null;
        const monthNamesID = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];

        // Initialize year filter for report
        function initReportYearFilter(availableYears) {
            const yearSelect = document.getElementById('reportFilterYear');
            if (!yearSelect) return;
            
            const currentYear = new Date().getFullYear();
            const years = availableYears && availableYears.length > 0 
                ? [...new Set([currentYear, ...availableYears])].sort((a, b) => b - a)
                : [currentYear, currentYear - 1, currentYear - 2];
            
            yearSelect.innerHTML = '<option value="">Semua Tahun</option>' + 
                years.map(y => `<option value="${y}">${y}</option>`).join('');
        }

        // Load sales report with filter
        async function loadSalesReportFiltered() {
            const month = document.getElementById('reportFilterMonth')?.value;
            const year = document.getElementById('reportFilterYear')?.value;
            
            // Build query params
            const params = new URLSearchParams();
            if (month) params.append('month', month);
            if (year) params.append('year', year);
            
            try {
                const resp = await API.authFetch(`/penjual/laporan?${params.toString()}`);
                if (!resp.ok) throw new Error('Failed to load report');
                salesReportData = await resp.json();

                // Update laba rugi stats
                document.getElementById('reportTotalPendapatan').textContent = `Rp ${Number(salesReportData.overall.total_pendapatan).toLocaleString('id-ID')}`;
                document.getElementById('reportTotalModal').textContent = `Rp ${Number(salesReportData.overall.total_modal || 0).toLocaleString('id-ID')}`;
                document.getElementById('reportLabaKotor').textContent = `Rp ${Number(salesReportData.overall.laba_kotor || 0).toLocaleString('id-ID')}`;
                document.getElementById('reportMarginPersen').textContent = `Margin: ${salesReportData.overall.margin_persen || 0}%`;
                
                // Update other stats
                document.getElementById('reportTotalTerjual').textContent = salesReportData.overall.total_terjual;
                document.getElementById('reportTotalTransaksi').textContent = salesReportData.overall.total_transaksi;

                // Update header stats
                document.getElementById('statRevenue').textContent = `Rp ${Number(salesReportData.overall.laba_kotor || salesReportData.overall.total_pendapatan).toLocaleString('id-ID')}`;
                document.getElementById('statRating').textContent = Number(salesReportData.rating.avg_rating).toFixed(1);

                // Render product sales with profit
                renderProductSales(salesReportData.products);
                renderMonthlySales(salesReportData.monthly);
                
                // Initialize year filter if available
                if (salesReportData.availableYears) {
                    initReportYearFilter(salesReportData.availableYears);
                }
                
                // Update period display
                updateReportPeriodDisplay(month, year);
            } catch (e) {
                console.error('Error loading report:', e);
                document.getElementById('productSalesContainer').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Gagal memuat laporan.</p>
                    </div>
                `;
            }
        }

        function resetReportFilter() {
            document.getElementById('reportFilterMonth').value = '';
            document.getElementById('reportFilterYear').value = '';
            document.getElementById('reportPeriodDisplay').style.display = 'none';
            loadSalesReportFiltered();
        }

        function updateReportPeriodDisplay(month, year) {
            const periodDisplay = document.getElementById('reportPeriodDisplay');
            const periodText = document.getElementById('reportPeriodText');
            
            if (!periodDisplay || !periodText) return;
            
            let text = '';
            if (month && year) {
                text = `Menampilkan laporan bulan ${monthNamesID[parseInt(month) - 1]} ${year}`;
            } else if (year) {
                text = `Menampilkan laporan tahun ${year}`;
            } else if (month) {
                text = `Menampilkan laporan bulan ${monthNamesID[parseInt(month) - 1]}`;
            } else {
                periodDisplay.style.display = 'none';
                return;
            }
            
            periodDisplay.style.display = 'block';
            periodText.textContent = text;
        }

        // Export to CSV
        function exportLaporanCSV() {
            if (!salesReportData) {
                API.showModal({ title: 'Info', message: 'Tidak ada data untuk diexport. Silakan muat laporan terlebih dahulu.' });
                return;
            }
            
            const month = document.getElementById('reportFilterMonth')?.value;
            const year = document.getElementById('reportFilterYear')?.value;
            const userName = document.getElementById('welcomeName').textContent.replace('Selamat Datang, ', '').replace('!', '');
            
            // Build period text
            let periodText = 'Semua Periode';
            let filenamePeriod = 'semua';
            if (month && year) {
                periodText = `${monthNamesID[parseInt(month) - 1]} ${year}`;
                filenamePeriod = `${year}-${month.toString().padStart(2, '0')}`;
            } else if (year) {
                periodText = `Tahun ${year}`;
                filenamePeriod = year;
            }
            
            const csv = [
                ['LAPORAN LABA RUGI - LAUTAN KITA'],
                [`Penjual: ${userName}`],
                [`Periode: ${periodText}`],
                [`Tanggal Export: ${new Date().toLocaleString('id-ID')}`],
                [''],
                ['RINGKASAN LABA RUGI'],
                [`Total Pendapatan,Rp ${Number(salesReportData.overall.total_pendapatan).toLocaleString('id-ID')}`],
                [`Total Modal (HPP),Rp ${Number(salesReportData.overall.total_modal || 0).toLocaleString('id-ID')}`],
                [`Laba Kotor,Rp ${Number(salesReportData.overall.laba_kotor || 0).toLocaleString('id-ID')}`],
                [`Margin Keuntungan,${salesReportData.overall.margin_persen || 0}%`],
                [`Total Produk Terjual,${salesReportData.overall.total_terjual}`],
                [`Total Transaksi,${salesReportData.overall.total_transaksi}`],
                [''],
                ['LABA RUGI PER PRODUK'],
                ['Nama Produk', 'Terjual', 'Pendapatan', 'Modal', 'Laba', 'Margin'].join(','),
                ...salesReportData.products.map(p => [
                    `"${p.nama_produk}"`,
                    p.total_terjual,
                    p.total_pendapatan,
                    p.total_modal || 0,
                    p.laba || 0,
                    `${p.margin_persen || 0}%`
                ].join(',')),
                [''],
                ['LABA RUGI BULANAN'],
                ['Periode', 'Terjual', 'Pendapatan', 'Modal', 'Laba'].join(','),
                ...salesReportData.monthly.map(m => {
                    const [yr, mn] = m.bulan.split('-');
                    return [
                        `${monthNamesID[parseInt(mn) - 1]} ${yr}`,
                        m.jumlah_terjual,
                        m.pendapatan,
                        m.modal || 0,
                        m.laba || 0
                    ].join(',');
                })
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Laporan-Penjualan-${userName.replace(/\s+/g, '-')}-${filenamePeriod}-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            API.showModal({ 
                title: 'Export Berhasil', 
                message: 'Laporan penjualan berhasil diexport ke file CSV.' 
            });
        }

        // Load sales report (original function - now calls filtered version)
        async function loadSalesReport() {
            try {
                const resp = await API.authFetch('/penjual/laporan');
                if (!resp.ok) throw new Error('Failed to load report');
                salesReportData = await resp.json();

                // Update laba rugi stats
                document.getElementById('reportTotalPendapatan').textContent = `Rp ${Number(salesReportData.overall.total_pendapatan).toLocaleString('id-ID')}`;
                document.getElementById('reportTotalModal').textContent = `Rp ${Number(salesReportData.overall.total_modal || 0).toLocaleString('id-ID')}`;
                document.getElementById('reportLabaKotor').textContent = `Rp ${Number(salesReportData.overall.laba_kotor || 0).toLocaleString('id-ID')}`;
                document.getElementById('reportMarginPersen').textContent = `Margin: ${salesReportData.overall.margin_persen || 0}%`;
                
                // Update other stats
                document.getElementById('reportTotalTerjual').textContent = salesReportData.overall.total_terjual;
                document.getElementById('reportTotalTransaksi').textContent = salesReportData.overall.total_transaksi;

                // Update header stats
                document.getElementById('statRevenue').textContent = `Rp ${Number(salesReportData.overall.total_pendapatan).toLocaleString('id-ID')}`;
                document.getElementById('statRating').textContent = Number(salesReportData.rating.avg_rating).toFixed(1);

                // Render product sales
                renderProductSales(salesReportData.products);
                renderMonthlySales(salesReportData.monthly);
                
                // Initialize year filter if available
                if (salesReportData.availableYears) {
                    initReportYearFilter(salesReportData.availableYears);
                }
            } catch (e) {
                console.error('Error loading report:', e);
                document.getElementById('productSalesContainer').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Gagal memuat laporan.</p>
                    </div>
                `;
            }
        }

        function renderProductSales(products) {
            const container = document.getElementById('productSalesContainer');
            if (!products.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-chart-line"></i>
                        <p>Belum ada data penjualan.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <table class="product-table">
                    <thead>
                        <tr>
                            <th>Produk</th>
                            <th>Terjual</th>
                            <th>Pendapatan</th>
                            <th>Modal (HPP)</th>
                            <th>Laba</th>
                            <th>Margin</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${products.map(p => {
                            const laba = Number(p.laba || 0);
                            const isProfit = laba >= 0;
                            return `
                            <tr>
                                <td>
                                    <div class="product-info">
                                        <img src="${p.photo_url ? (API_BASE + p.photo_url) : 'img/logo.png'}" 
                                             alt="${p.nama_produk}" class="product-thumb" 
                                             onerror="this.src='img/logo.png'">
                                        <div>
                                            <div style="font-weight: 600;">${p.nama_produk}</div>
                                            <small style="color: #64748B;">Stok: ${p.stok}</small>
                                        </div>
                                    </div>
                                </td>
                                <td><strong>${p.total_terjual}</strong> unit</td>
                                <td style="color: #0077B6; font-weight: 600;">Rp ${Number(p.total_pendapatan).toLocaleString('id-ID')}</td>
                                <td style="color: #EF4444;">Rp ${Number(p.total_modal || 0).toLocaleString('id-ID')}</td>
                                <td style="color: ${isProfit ? '#10B981' : '#EF4444'}; font-weight: 700;">
                                    ${isProfit ? '+' : ''}Rp ${laba.toLocaleString('id-ID')}
                                </td>
                                <td>
                                    <span style="background: ${isProfit ? '#D1FAE5' : '#FEE2E2'}; color: ${isProfit ? '#065F46' : '#991B1B'}; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                        ${p.margin_persen || 0}%
                                    </span>
                                </td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderMonthlySales(monthly) {
            const container = document.getElementById('monthlySalesContainer');
            if (!monthly.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar"></i>
                        <p>Belum ada data penjualan bulanan.</p>
                    </div>
                `;
                return;
            }

            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px;">
                    ${monthly.map(m => {
                const [year, month] = m.bulan.split('-');
                const laba = Number(m.laba || 0);
                const isProfit = laba >= 0;
                return `
                            <div style="background: #f8fafc; padding: 16px; border-radius: 8px; border-left: 4px solid ${isProfit ? '#10B981' : '#EF4444'};">
                                <div style="font-weight: 600; color: #07304A; margin-bottom: 8px;">
                                    ${monthNames[parseInt(month) - 1]} ${year}
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <span style="color: #64748B; font-size: 13px;">Pendapatan:</span>
                                    <span style="color: #0077B6; font-weight: 600;">Rp ${Number(m.pendapatan).toLocaleString('id-ID')}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <span style="color: #64748B; font-size: 13px;">Modal:</span>
                                    <span style="color: #EF4444; font-weight: 600;">Rp ${Number(m.modal || 0).toLocaleString('id-ID')}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px dashed #e5e7eb; margin-top: 8px;">
                                    <span style="color: #07304A; font-weight: 600;">Laba:</span>
                                    <span style="color: ${isProfit ? '#10B981' : '#EF4444'}; font-weight: 700;">
                                        ${isProfit ? '+' : ''}Rp ${laba.toLocaleString('id-ID')}
                                    </span>
                                </div>
                                <div style="color: #64748B; font-size: 12px; margin-top: 8px;">
                                    <i class="fas fa-shopping-bag"></i> ${m.jumlah_terjual} terjual â€¢ ${m.jumlah_transaksi} transaksi
                                </div>
                            </div>
                        `;
            }).join('')}
                </div>
            `;
        }

        // Export laporan penjualan ke PDF - format laporan keuangan
        async function exportLaporanPDF() {
            try {
                // Use existing data or fetch fresh
                let reportData = salesReportData;
                if (!reportData) {
                    const resp = await API.authFetch('/penjual/laporan');
                    if (!resp.ok) throw new Error('Failed to load report data');
                    reportData = await resp.json();
                }

                // Get filter values
                const month = document.getElementById('reportFilterMonth')?.value;
                const year = document.getElementById('reportFilterYear')?.value;

                // Get seller name
                const userName = document.getElementById('welcomeName').textContent.replace('Selamat Datang, ', '').replace('!', '');
                const today = new Date();
                const formattedDate = today.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });
                
                // Build period text
                let periodText = 'Semua Periode';
                let filenamePeriod = 'semua';
                if (month && year) {
                    periodText = `${monthNamesID[parseInt(month) - 1]} ${year}`;
                    filenamePeriod = `${year}-${month.toString().padStart(2, '0')}`;
                } else if (year) {
                    periodText = `Tahun ${year}`;
                    filenamePeriod = year;
                }

                // Calculate totals
                const totalPendapatan = Number(reportData.overall.total_pendapatan) || 0;
                const totalTerjual = Number(reportData.overall.total_terjual) || 0;
                const totalTransaksi = Number(reportData.overall.total_transaksi) || 0;

                // Build product rows for table with profit/loss
                let productRows = '';
                let no = 1;
                reportData.products.forEach(p => {
                    const terjual = Number(p.total_terjual) || 0;
                    const pendapatan = Number(p.total_pendapatan) || 0;
                    const modal = Number(p.total_modal) || 0;
                    const laba = Number(p.laba) || 0;
                    const margin = p.margin_persen || 0;
                    productRows += `
                        <tr>
                            <td style="border: 1px solid #000; padding: 8px; text-align: center;">${no++}</td>
                            <td style="border: 1px solid #000; padding: 8px;">${p.nama_produk}</td>
                            <td style="border: 1px solid #000; padding: 8px; text-align: center;">${terjual}</td>
                            <td style="border: 1px solid #000; padding: 8px; text-align: right;">Rp ${pendapatan.toLocaleString('id-ID')}</td>
                            <td style="border: 1px solid #000; padding: 8px; text-align: right;">Rp ${modal.toLocaleString('id-ID')}</td>
                            <td style="border: 1px solid #000; padding: 8px; text-align: right;">${laba >= 0 ? '+' : ''}Rp ${laba.toLocaleString('id-ID')}</td>
                            <td style="border: 1px solid #000; padding: 8px; text-align: center;">${margin}%</td>
                        </tr>
                    `;
                });

                // Build monthly rows with profit/loss
                let monthlyRows = '';
                const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
                reportData.monthly.forEach(m => {
                    const [year, month] = m.bulan.split('-');
                    const pendapatan = Number(m.pendapatan) || 0;
                    const modal = Number(m.modal) || 0;
                    const laba = Number(m.laba) || 0;
                    const terjual = Number(m.jumlah_terjual) || 0;
                    monthlyRows += `
                        <tr>
                            <td style="border: 1px solid #000; padding: 8px;">${monthNames[parseInt(month) - 1]} ${year}</td>
                            <td style="border: 1px solid #000; padding: 8px; text-align: center;">${terjual}</td>
                            <td style="border: 1px solid #000; padding: 8px; text-align: right;">Rp ${pendapatan.toLocaleString('id-ID')}</td>
                            <td style="border: 1px solid #000; padding: 8px; text-align: right;">Rp ${modal.toLocaleString('id-ID')}</td>
                            <td style="border: 1px solid #000; padding: 8px; text-align: right;">${laba >= 0 ? '+' : ''}Rp ${laba.toLocaleString('id-ID')}</td>
                        </tr>
                    `;
                });

                // Create PDF content - formal financial report style
                const pdfContent = document.createElement('div');
                pdfContent.innerHTML = `
                    <div style="padding: 30px; font-family: 'Times New Roman', Times, serif; color: #000; font-size: 12px; line-height: 1.5;">
                        <!-- Header -->
                        <div style="text-align: center; margin-bottom: 20px;">
                            <h1 style="margin: 0; font-size: 18px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px;">LAPORAN PENJUALAN</h1>
                            <h2 style="margin: 5px 0; font-size: 14px; font-weight: normal;">Lautan Kita - Marketplace Hasil Laut</h2>
                            <p style="margin: 5px 0; font-size: 12px;">Periode: ${periodText}</p>
                        </div>

                        <hr style="border: none; border-top: 2px solid #000; margin: 15px 0;">

                        <!-- Informasi Penjual -->
                        <table style="width: 100%; margin-bottom: 20px; font-size: 12px;">
                            <tr>
                                <td style="width: 120px;">Nama Penjual</td>
                                <td style="width: 10px;">:</td>
                                <td><strong>${userName}</strong></td>
                            </tr>
                            <tr>
                                <td>Tanggal Cetak</td>
                                <td>:</td>
                                <td>${formattedDate}</td>
                            </tr>
                        </table>

                        <!-- Ringkasan Laba Rugi -->
                        <h3 style="font-size: 13px; margin: 20px 0 10px; border-bottom: 1px solid #000; padding-bottom: 5px;">I. LAPORAN LABA RUGI</h3>
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                            <tr>
                                <td style="padding: 5px 0; width: 200px;">Total Pendapatan (Penjualan)</td>
                                <td style="padding: 5px 0; width: 10px;">:</td>
                                <td style="padding: 5px 0; text-align: right;">Rp ${totalPendapatan.toLocaleString('id-ID')}</td>
                            </tr>
                            <tr>
                                <td style="padding: 5px 0;">Total Modal (HPP)</td>
                                <td style="padding: 5px 0;">:</td>
                                <td style="padding: 5px 0; text-align: right;">(Rp ${Number(reportData.overall.total_modal || 0).toLocaleString('id-ID')})</td>
                            </tr>
                            <tr style="border-top: 1px solid #000;">
                                <td style="padding: 8px 0; font-weight: bold;">LABA KOTOR</td>
                                <td style="padding: 8px 0;">:</td>
                                <td style="padding: 8px 0; text-align: right; font-weight: bold;">Rp ${Number(reportData.overall.laba_kotor || 0).toLocaleString('id-ID')}</td>
                            </tr>
                            <tr>
                                <td style="padding: 5px 0;">Margin Keuntungan</td>
                                <td style="padding: 5px 0;">:</td>
                                <td style="padding: 5px 0; text-align: right;">${reportData.overall.margin_persen || 0}%</td>
                            </tr>
                        </table>
                        
                        <h3 style="font-size: 13px; margin: 20px 0 10px; border-bottom: 1px solid #000; padding-bottom: 5px;">II. RINGKASAN PENJUALAN</h3>
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                            <tr>
                                <td style="padding: 5px 0; width: 200px;">Total Produk Terjual</td>
                                <td style="padding: 5px 0; width: 10px;">:</td>
                                <td style="padding: 5px 0; text-align: right;">${totalTerjual} unit</td>
                            </tr>
                            <tr>
                                <td style="padding: 5px 0;">Total Transaksi</td>
                                <td style="padding: 5px 0;">:</td>
                                <td style="padding: 5px 0; text-align: right;">${totalTransaksi} transaksi</td>
                            </tr>
                        </table>

                        <!-- Detail Penjualan per Produk -->
                        <h3 style="font-size: 13px; margin: 20px 0 10px; border-bottom: 1px solid #000; padding-bottom: 5px;">III. RINCIAN PENJUALAN PER PRODUK</h3>
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 11px;">
                            <thead>
                                <tr style="background: #f0f0f0;">
                                    <th style="border: 1px solid #000; padding: 6px; text-align: center; width: 30px;">No</th>
                                    <th style="border: 1px solid #000; padding: 6px; text-align: left;">Nama Produk</th>
                                    <th style="border: 1px solid #000; padding: 6px; text-align: center; width: 50px;">Qty</th>
                                    <th style="border: 1px solid #000; padding: 6px; text-align: right; width: 90px;">Pendapatan</th>
                                    <th style="border: 1px solid #000; padding: 6px; text-align: right; width: 90px;">Modal</th>
                                    <th style="border: 1px solid #000; padding: 6px; text-align: right; width: 90px;">Laba</th>
                                    <th style="border: 1px solid #000; padding: 6px; text-align: center; width: 50px;">Margin</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${productRows || '<tr><td colspan="7" style="border: 1px solid #000; padding: 8px; text-align: center;">Belum ada data penjualan</td></tr>'}
                            </tbody>
                            <tfoot>
                                <tr style="background: #f0f0f0; font-weight: bold;">
                                    <td colspan="2" style="border: 1px solid #000; padding: 6px; text-align: right;">TOTAL</td>
                                    <td style="border: 1px solid #000; padding: 6px; text-align: center;">${totalTerjual}</td>
                                    <td style="border: 1px solid #000; padding: 6px; text-align: right;">Rp ${totalPendapatan.toLocaleString('id-ID')}</td>
                                    <td style="border: 1px solid #000; padding: 6px; text-align: right;">Rp ${Number(reportData.overall.total_modal || 0).toLocaleString('id-ID')}</td>
                                    <td style="border: 1px solid #000; padding: 6px; text-align: right;">Rp ${Number(reportData.overall.laba_kotor || 0).toLocaleString('id-ID')}</td>
                                    <td style="border: 1px solid #000; padding: 6px; text-align: center;">${reportData.overall.margin_persen || 0}%</td>
                                </tr>
                            </tfoot>
                        </table>

                        <!-- Penjualan Bulanan -->
                        <h3 style="font-size: 13px; margin: 20px 0 10px; border-bottom: 1px solid #000; padding-bottom: 5px;">IV. REKAPITULASI LABA RUGI BULANAN</h3>
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                            <thead>
                                <tr style="background: #f0f0f0;">
                                    <th style="border: 1px solid #000; padding: 8px; text-align: left;">Periode</th>
                                    <th style="border: 1px solid #000; padding: 8px; text-align: center; width: 60px;">Qty</th>
                                    <th style="border: 1px solid #000; padding: 8px; text-align: right; width: 110px;">Pendapatan</th>
                                    <th style="border: 1px solid #000; padding: 8px; text-align: right; width: 110px;">Modal</th>
                                    <th style="border: 1px solid #000; padding: 8px; text-align: right; width: 110px;">Laba/Rugi</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${monthlyRows || '<tr><td colspan="5" style="border: 1px solid #000; padding: 8px; text-align: center;">Belum ada data penjualan bulanan</td></tr>'}
                            </tbody>
                        </table>

                        <!-- Footer -->
                        <div style="margin-top: 40px;">
                            <div style="float: right; text-align: center; width: 200px;">
                                <p style="margin: 0;">${formattedDate}</p>
                                <p style="margin: 40px 0 5px;">_______________________</p>
                                <p style="margin: 0; font-weight: bold;">${userName}</p>
                                <p style="margin: 0; font-size: 11px;">Penjual</p>
                            </div>
                            <div style="clear: both;"></div>
                        </div>

                        <hr style="border: none; border-top: 1px solid #ccc; margin: 30px 0 10px;">
                        <p style="text-align: center; font-size: 10px; color: #666; margin: 0;">
                            Dokumen ini digenerate secara otomatis oleh sistem Lautan Kita pada ${today.toLocaleString('id-ID')}<br>
                            Â© ${today.getFullYear()} Lautan Kita - Marketplace Hasil Laut
                        </p>
                    </div>
                `;

                // PDF options
                const opt = {
                    margin: 10,
                    filename: `Laporan-Penjualan-${userName.replace(/\s+/g, '-')}-${filenamePeriod}-${today.toISOString().split('T')[0]}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                // Generate PDF
                await html2pdf().set(opt).from(pdfContent).save();

                API.showModal({
                    title: 'Berhasil',
                    message: 'Laporan penjualan berhasil diexport ke PDF!',
                    actions: [{ label: 'OK', variant: 'primary', handler: () => API.hideModal() }]
                });
            } catch (e) {
                console.error('Error exporting PDF:', e);
                API.showModal({
                    title: 'Error',
                    message: 'Gagal mengexport laporan ke PDF.',
                    actions: [{ label: 'OK', variant: 'primary', handler: () => API.hideModal() }]
                });
            }
        }

        // Load seller reviews
        async function loadSellerReviews() {
            try {
                const resp = await API.authFetch('/penjual/ulasan');
                if (!resp.ok) throw new Error('Failed to load reviews');
                const reviews = await resp.json();
                renderSellerReviews(reviews);
            } catch (e) {
                console.error('Error loading reviews:', e);
                document.getElementById('reviewsContainer').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Gagal memuat ulasan.</p>
                    </div>
                `;
            }
        }

        function renderSellerReviews(reviews) {
            const container = document.getElementById('reviewsContainer');
            if (!reviews.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-comments"></i>
                        <p>Belum ada ulasan dari pembeli.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = reviews.map(r => `
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <img src="${r.photo_url ? (API_BASE + r.photo_url) : 'img/logo.png'}" 
                                 alt="${r.nama_produk}" 
                                 style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;"
                                 onerror="this.src='img/logo.png'">
                            <div>
                                <div style="font-weight: 600; color: #07304A;">${r.nama_produk}</div>
                                <div style="color: #64748B; font-size: 14px;">oleh ${r.pembeli_nama}</div>
                            </div>
                        </div>
                        <div style="color: #F59E0B; font-size: 16px;">
                            ${renderStars(r.rating)}
                        </div>
                    </div>
                    ${r.komentar ? `<p style="color: #374151; margin: 0;">"${r.komentar}"</p>` : '<p style="color: #9CA3AF; font-style: italic;">Tidak ada komentar</p>'}
                    <div style="color: #9CA3AF; font-size: 12px; margin-top: 8px;">
                        ${new Date(r.dibuat_pada).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}
                    </div>
                </div>
            `).join('');
        }

        function renderStars(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                stars += `<i class="fas fa-star" style="color: ${i <= rating ? '#F59E0B' : '#E5E7EB'}"></i>`;
            }
            return stars;
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>