<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Detail Produk - Lautan Kita</title>
    <link rel="stylesheet" href="Desktop2style.css" />
    <script src="assets/js/api.js"></script>
</head>

<body>
    <div class="container">
        <a class="back-button" href="home_final.html">‚¨ÖÔ∏è</a>

        <section class="product-section">
            <div class="image-wrapper">
                <img id="productImage" src="img/logo.png" alt="Produk" />
            </div>

            <div class="product-info">
                <div class="info-header">
                    <div class="info-left">
                        <h1 id="productName">Memuat...</h1>
                        <p class="price" id="productPrice">Rp. 0/kg</p>
                        <p class="stock" id="productStock">Stok: 0 kg</p>
                    </div>
                    <div class="info-right">
                        <div class="rating" id="productRating">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                        <div class="actions">
                            <button class="cart-button" id="addToCartBtn" onclick="addToCartFromDetail()">üõí
                                Keranjang</button>
                            <button class="buy-button" id="buyNowBtn" onclick="buyNowFromDetail()">Beli
                                Sekarang</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="description info-card">
                <h3>Deskripsi Produk</h3>
                <p id="productDescription">Memuat deskripsi produk...</p>
                <ul id="productDetails">
                    <li>Status: <span id="productStatus">Tersedia</span></li>
                    <li>Kategori: <span id="productCategory">-</span></li>
                </ul>
                <p>üöö Siap Kirim! Kami siap melayani pengiriman cepat.</p>
            </div>

            <div class="review-card info-card seller-review-display">
                <div class="card-header">
                    <img id="sellerAvatar" src="img/penjual.png" alt="Penjual" class="avatar" />
                    <div class="review-meta">
                        <strong class="review-name" id="sellerName">Penjual</strong>
                        <p class="review-text">Penjual terpercaya</p>
                        <button class="visit-button" onclick="visitSeller()">Kunjungi</button>
                    </div>
                    <div class="rating">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                </div>
            </div>

            <!-- Reviews Section -->
            <div class="info-card" id="reviewsSection" style="margin-top: 20px;">
                <h3 style="margin-bottom: 16px; color: #0077B6;">
                    <span style="margin-right: 8px;">‚≠ê</span> Ulasan Pembeli
                    <span id="reviewCount" style="font-size: 14px; color: #64748B; font-weight: normal;">(0
                        ulasan)</span>
                </h3>
                <div id="reviewsContainer">
                    <p style="color: #64748B; text-align: center; padding: 20px;">Memuat ulasan...</p>
                </div>
            </div>

        </section>
    </div>

    <footer>
        <div class="footer-container">
            <div class="footer-left">
                <h4>Lautan Kita</h4>
                <p>
                    Lautan Kita adalah platform digital inovatif yang menghubungkan nelayan lokal langsung dengan
                    konsumen dan bisnis, menyediakan produk laut segar, transparan, dan berkelanjutan.
                </p>

                <div class="footer-nav">
                    <h5><a href="home_final.html" class="footer-link">Beranda</a></h5>
                    <h5><a href="keranjang.html" class="footer-link">Keranjang</a></h5>
                    <h5><a href="pusat_bantuan.html" class="footer-link">Pusat Bantuan</a></h5>
                </div>
            </div>
            <div class="footer-right">
                <h4>Kontak Kami:</h4>
                <p>üì∏ @lautankita</p>
                <p>üéµ @lautankita</p>
                <p>üìû +62 811 1234 5678</p>
                <p>‚úâÔ∏è lautankita@gmail.com</p>
                <h4>Alamat:</h4>
                <p>üìç Ganet, BT 11, Tanjung Pinang Timur, Tanjung Pinang, Kepulauan Riau</p>
            </div>
        </div>
        <p class="copyright">¬© 2025 Lautan Kita. All rights reserved</p>
    </footer>

    <script>
        const API_BASE = (window.API && window.API.base) || 'http://localhost:4000';
        let currentProduct = null;

        // Mapping kategori ID ke nama
        const categoryMap = {
            1: 'Ikan Laut',
            2: 'Udang',
            3: 'Kepiting',
            4: 'Sotong',
            5: 'Cumi-cumi'
        };



        // Helper function untuk mendapatkan gambar default berdasarkan nama produk
        function getDefaultImage(productName) {
            const name = productName.toLowerCase();
            if (name.includes('belanak')) return 'img/ikan-belanak.png';
            if (name.includes('puri')) return 'img/ikan-puri.png';
            if (name.includes('udang')) return 'img/udang.png';
            if (name.includes('kepiting')) return 'img/kepiting.png';
            if (name.includes('tongkol')) return 'img/ikan-tongkol.png';
            if (name.includes('sotong') || name.includes('cumi')) return 'img/sotong.png';
            if (name.includes('kakap')) return 'img/ikan-kakap.png';
            return 'img/logo.png';
        }

        async function loadProductDetail() {
            const params = new URLSearchParams(window.location.search);
            const productId = params.get('id');

            if (!productId) {
                API.showModal({
                    title: 'Error',
                    message: 'ID produk tidak ditemukan!',
                    actions: [{ label: 'Kembali', variant: 'primary', handler: () => { window.location.href = 'home_final.html'; } }]
                });
                return;
            }

            try {
                // Coba ambil dari backend API
                const resp = await fetch(API_BASE + '/products');
                if (resp.ok) {
                    const products = await resp.json();
                    // Cari produk berdasarkan ID numerik atau nama yang di-slugify
                    const product = products.find(p => {
                        const slugName = p.nama_produk.toLowerCase().replace(/\s+/g, '-');
                        return p.produk_id == productId || slugName === productId;
                    });

                    if (product) {
                        currentProduct = {
                            id: product.produk_id,
                            name: product.nama_produk,
                            price: Number(product.harga),
                            image: product.photo_url ? (API_BASE + product.photo_url) : getDefaultImage(product.nama_produk),
                            description: product.deskripsi || 'Produk segar hasil tangkapan nelayan lokal. Kualitas terjamin dan siap dikirim ke seluruh Indonesia.',
                            seller: product.penjual_nama || 'Penjual',
                            rating: 5,
                            stock: product.stok || 0,
                            category: categoryMap[product.kategori_id] || 'Hasil Laut',
                            status: product.status === 'aktif' ? 'Tersedia' : 'Tidak Tersedia'
                        };
                        renderProduct(currentProduct);
                        // Load reviews for this product
                        loadProductReviews(product.produk_id);
                        return;
                    }
                }
            } catch (e) {
                console.error('Error loading product:', e);
                API.showModal({
                    title: 'Error',
                    message: 'Gagal memuat produk. Silakan coba lagi.',
                    actions: [{ label: 'Kembali', variant: 'primary', handler: () => { window.location.href = 'home_final.html'; } }]
                });
            }
        }

        function renderProduct(product) {
            // Update title
            document.title = `${product.name} - Lautan Kita`;

            // Update gambar
            document.getElementById('productImage').src = product.image;
            document.getElementById('productImage').alt = product.name;

            // Update info produk
            document.getElementById('productName').textContent = product.name;
            document.getElementById('productPrice').textContent = `Rp. ${product.price.toLocaleString('id-ID')}/kg`;
            document.getElementById('productStock').textContent = `Stok: ${product.stock} kg`;

            // Update rating
            const ratingEl = document.getElementById('productRating');
            let stars = '';
            for (let i = 0; i < 5; i++) {
                stars += i < (product.rating || 5) ? '‚òÖ' : '‚òÜ';
            }
            ratingEl.textContent = stars;

            // Update deskripsi
            document.getElementById('productDescription').textContent = product.description;
            document.getElementById('productStatus').textContent = product.status || 'Tersedia';
            document.getElementById('productCategory').textContent = product.category || 'Hasil Laut';

            // Update info penjual
            document.getElementById('sellerName').textContent = product.seller;

            // Update review jika ada
            if (product.reviews && product.reviews.length > 0) {
                const review = product.reviews[0];
                const reviewCard = document.getElementById('userReviewCard');
                reviewCard.style.display = 'block';

                document.getElementById('reviewUser').textContent = review.user;
                document.getElementById('reviewComment').innerHTML = review.comment;

                const reviewRatingEl = document.getElementById('reviewRating');
                let reviewStars = '';
                for (let i = 0; i < 5; i++) {
                    reviewStars += i < review.rating ? '‚òÖ' : '‚òÜ';
                }
                reviewRatingEl.textContent = reviewStars;

                if (review.img) {
                    document.getElementById('reviewImage').src = review.img;
                    document.getElementById('reviewImage').style.display = 'block';
                }
            }
        }

        async function addToCartFromDetail() {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                API.showModal({
                    title: 'Login Diperlukan',
                    message: 'Silakan login terlebih dahulu untuk menambahkan produk ke keranjang.',
                    actions: [
                        { label: 'Login', variant: 'primary', handler: () => { window.location.href = 'login.html'; } },
                        { label: 'Batal', variant: 'secondary', handler: API.hideModal }
                    ]
                });
                return;
            }

            // Check user role
            try {
                const meResp = await API.authFetch('/auth/me');
                if (meResp.ok) {
                    const user = await meResp.json();
                    if (user.role === 'penjual') {
                        API.showModal({
                            title: 'Akun Penjual',
                            message: 'Akun penjual tidak dapat membeli produk. Kelola stok produk Anda di dashboard.',
                            actions: [{ label: 'OK', variant: 'primary', handler: API.hideModal }]
                        });
                        return;
                    }
                    if (user.role === 'kurir') {
                        API.showModal({
                            title: 'Akun Kurir',
                            message: 'Akun kurir tidak dapat membeli produk. Fokus pada pengiriman pesanan.',
                            actions: [{ label: 'OK', variant: 'primary', handler: API.hideModal }]
                        });
                        return;
                    }
                    if (user.role === 'admin') {
                        API.showModal({
                            title: 'Akun Admin',
                            message: 'Akun admin tidak dapat membeli produk. Kelola sistem di admin panel.',
                            actions: [{ label: 'OK', variant: 'primary', handler: API.hideModal }]
                        });
                        return;
                    }
                }
            } catch (e) {
                console.error('Failed to check user role', e);
            }

            if (!currentProduct) return;

            try {
                const resp = await API.authFetch('/carts/items', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        produk_id: currentProduct.id,
                        jumlah: 1
                    })
                });

                if (resp.ok) {
                    API.showModal({
                        title: 'Berhasil',
                        message: 'Produk berhasil ditambahkan ke keranjang!',
                        actions: [
                            { label: 'Lihat Keranjang', variant: 'primary', handler: () => { window.location.href = 'keranjang.html'; } },
                            { label: 'Lanjut Belanja', variant: 'secondary', handler: API.hideModal }
                        ]
                    });
                } else {
                    const error = await resp.json();
                    API.showModal({ title: 'Error', message: error.error === 'forbidden' ? 'Anda tidak memiliki akses untuk membeli produk.' : 'Gagal menambahkan ke keranjang.' });
                }
            } catch (e) {
                API.showModal({ title: 'Error', message: 'Terjadi kesalahan jaringan.' });
            }
        }

        async function buyNowFromDetail() {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                API.showModal({
                    title: 'Login Diperlukan',
                    message: 'Silakan login terlebih dahulu untuk membeli produk.',
                    actions: [
                        { label: 'Login', variant: 'primary', handler: () => { window.location.href = 'login.html'; } },
                        { label: 'Batal', variant: 'secondary', handler: API.hideModal }
                    ]
                });
                return;
            }

            // Check user role
            try {
                const meResp = await API.authFetch('/auth/me');
                if (meResp.ok) {
                    const user = await meResp.json();
                    if (user.role === 'penjual') {
                        API.showModal({
                            title: 'Akun Penjual',
                            message: 'Akun penjual tidak dapat membeli produk. Kelola stok produk Anda di dashboard.',
                            actions: [{ label: 'OK', variant: 'primary', handler: API.hideModal }]
                        });
                        return;
                    }
                    if (user.role === 'kurir') {
                        API.showModal({
                            title: 'Akun Kurir',
                            message: 'Akun kurir tidak dapat membeli produk. Fokus pada pengiriman pesanan.',
                            actions: [{ label: 'OK', variant: 'primary', handler: API.hideModal }]
                        });
                        return;
                    }
                    if (user.role === 'admin') {
                        API.showModal({
                            title: 'Akun Admin',
                            message: 'Akun admin tidak dapat membeli produk. Kelola sistem di admin panel.',
                            actions: [{ label: 'OK', variant: 'primary', handler: API.hideModal }]
                        });
                        return;
                    }
                }
            } catch (e) {
                console.error('Failed to check user role', e);
            }

            if (!currentProduct) return;

            // Tambah ke keranjang dulu, lalu redirect ke checkout
            try {
                const resp = await API.authFetch('/carts/items', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        produk_id: currentProduct.id,
                        jumlah: 1
                    })
                });

                if (resp.ok) {
                    window.location.href = 'checkout.html';
                } else {
                    const error = await resp.json();
                    API.showModal({ title: 'Error', message: error.error === 'forbidden' ? 'Anda tidak memiliki akses untuk membeli produk.' : 'Gagal memproses pembelian.' });
                }
            } catch (e) {
                API.showModal({ title: 'Error', message: 'Terjadi kesalahan jaringan.' });
            }
        }

        function visitSeller() {
            API.showModal({
                title: 'Info',
                message: 'Fitur kunjungi toko penjual akan segera hadir!',
                actions: [{ label: 'OK', variant: 'primary', handler: API.hideModal }]
            });
        }

        async function loadProductReviews(productId) {
            try {
                const resp = await fetch(`${API_BASE}/products/${productId}/reviews`);
                if (!resp.ok) throw new Error('Failed to load reviews');

                const data = await resp.json();
                renderReviews(data);
            } catch (e) {
                console.error('Error loading reviews:', e);
                document.getElementById('reviewsContainer').innerHTML = `
                    <p style="color: #64748B; text-align: center; padding: 20px;">Belum ada ulasan untuk produk ini.</p>
                `;
            }
        }

        function renderReviews(data) {
            const container = document.getElementById('reviewsContainer');
            const countEl = document.getElementById('reviewCount');

            countEl.textContent = `(${data.total_reviews} ulasan)`;

            // Update product rating display
            if (data.avg_rating > 0) {
                const ratingEl = document.getElementById('productRating');
                const avgRating = Math.round(data.avg_rating);
                let stars = '';
                for (let i = 0; i < 5; i++) {
                    stars += i < avgRating ? '‚òÖ' : '‚òÜ';
                }
                ratingEl.textContent = stars + ` (${Number(data.avg_rating).toFixed(1)})`;
            }

            if (!data.reviews || data.reviews.length === 0) {
                container.innerHTML = `
                    <p style="color: #64748B; text-align: center; padding: 20px;">Belum ada ulasan untuk produk ini.</p>
                `;
                return;
            }

            container.innerHTML = data.reviews.map(r => `
                <div style="border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-bottom: 12px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: #0077B6; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                ${(r.pembeli_nama || 'U').charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div style="font-weight: 600; color: #07304A;">${r.pembeli_nama || 'Pembeli'}</div>
                                <div style="font-size: 12px; color: #64748B;">${new Date(r.tanggal).toLocaleDateString('id-ID')}</div>
                            </div>
                        </div>
                        <div style="color: #F59E0B; font-size: 16px;">
                            ${'‚òÖ'.repeat(r.rating)}${'‚òÜ'.repeat(5 - r.rating)}
                        </div>
                    </div>
                    <p style="color: #374151; line-height: 1.6; margin: 0;">${r.komentar || '-'}</p>
                    ${r.balasan_admin ? `
                        <div style="background: #E0F2FE; padding: 12px; border-radius: 8px; margin-top: 12px; border-left: 3px solid #0077B6;">
                            <div style="font-size: 12px; color: #0077B6; font-weight: 600; margin-bottom: 4px;">
                                ‚Ü©Ô∏è Balasan dari ${r.admin_nama || 'Admin'}
                            </div>
                            <p style="color: #374151; margin: 0; font-size: 14px;">${r.balasan_admin}</p>
                            <div style="font-size: 11px; color: #64748B; margin-top: 4px;">
                                ${r.tanggal_balasan ? new Date(r.tanggal_balasan).toLocaleDateString('id-ID') : ''}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // Load product saat halaman dimuat
        window.addEventListener('DOMContentLoaded', loadProductDetail);
    </script>
</body>

</html>