<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Keranjang Lautan Kita</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      --primary-bg: #0077B6;
      --header-bg: #EFF6FF;
      --body-bg: #EFF6FF;
      --price-color: #0077B6;
    }
    
    .btn-secondary { background: #e5e7eb; color: #111827; border: none; border-radius: 10px; padding: 10px 16px; cursor: pointer; }
  </style>
  <script src="assets/js/api.js"></script>
</head>
<body class="min-h-screen flex flex-col" style="background-color: var(--body-bg);">

  <!-- Header -->
  <div class="p-4" style="background-color: var(--header-bg);">
    <div class="flex items-center gap-2">
      <button onclick="window.location.href='home_final.html'" class="rounded-lg px-3 py-2 shadow" style="background-color: var(--primary-bg);">
        <img src="img/arrowback.png" width="24" height="22" alt="Kembali">
      </button>
    </div>
    <div class="border-b-2 my-3" style="border-color: #7BD5FE;"></div>
    <h2 class="text-lg font-semibold text-[#07304A] mt-2">Keranjang Belanja</h2>
    <div class="border-b-2 my-3" style="border-color: #7BD5FE;"></div>
  </div>

  <!-- Isi Keranjang -->
  <div class="flex-1 p-4 space-y-4" id="cartItemsContainer">
    <!-- Produk akan dimuat secara dinamis -->
  </div>
  

  <!-- Footer -->
  <div class="p-4 text-white flex justify-between items-center" style="background-color: var(--primary-bg);">
    <div id="totalHarga" class="ml-2 font-semibold whitespace-nowrap">Total Rp0</div>
    <button id="pesanBtn" class="bg-white px-4 py-2 rounded font-semibold text-[#0077B6]">Pesan</button>
  </div>

  <!-- Script -->
  <script>
    const apiScript=document.createElement('script'); apiScript.src='assets/js/api.js'; document.head.appendChild(apiScript);
    const API_BASE = 'http://localhost:4000';

    document.addEventListener('DOMContentLoaded', loadCartBackend);

    async function loadCartBackend() {
      const token = localStorage.getItem('auth_token');
      const container = document.getElementById('cartItemsContainer');
      if (!token) { container.innerHTML = '<p class="text-center text-gray-600">Silakan login untuk melihat keranjang.</p>'; return; }
      try {
        const resp = await fetch(API_BASE + '/carts', { headers: { Authorization: 'Bearer ' + token }});
        if (!resp.ok) { container.innerHTML = '<p class="text-center text-gray-600">Gagal memuat keranjang.</p>'; return; }
        const data = await resp.json();
        const items = data.items || [];
        if (!items.length) {
          container.innerHTML = '<p class="text-center text-gray-600">Keranjang Anda kosong.</p>';
          document.getElementById('pesanBtn').disabled = true;
          document.getElementById('pesanBtn').classList.add('opacity-50','cursor-not-allowed');
          document.getElementById('totalHarga').textContent = 'Total Rp0';
          return;
        }
        container.innerHTML = '';
        let total = 0;
        items.forEach((item) => {
          total += Number(item.subtotal || 0);
          const el = document.createElement('div');
          el.className = 'rounded-xl shadow p-4 flex items-center gap-4 bg-white';
          el.innerHTML = `
            <img src="img/logo.png" class="w-20 h-20 object-cover rounded-md">
            <div class="flex-1">
              <div class="font-semibold text-lg text-[#07304A]">${item.nama_produk || 'Produk'}</div>
              <div class="flex items-center gap-2 mt-1">
                <button onclick="updateQuantityBackend(${item.item_id}, ${item.jumlah - 1})" class="bg-[#0077B6] text-white px-2 rounded">-</button>
                <span class="tect-sm text-[#07304A]">${item.jumlah} kg</span>
                <button onclick="updateQuantityBackend(${item.item_id}, ${item.jumlah + 1})" class="bg-[#0077B6] text-white px-2 rounded">+</button>
                <button onclick="hapusItemBackend(${item.item_id})" title="Hapus" style="margin-left:16px;background:#ff4444;color:white;border:none;border-radius:5px;padding:5px 10px;cursor:pointer;">Hapus</button>
              </div>
              <div class="font-semibold text-[#0077B6]">Rp. ${Number(item.harga || item.price || 0).toLocaleString('id-ID')}</div>
            </div>
          `;
          container.appendChild(el);
        });
        document.getElementById('totalHarga').textContent = `Total Rp${total.toLocaleString('id-ID')}`;
        document.getElementById('pesanBtn').onclick = () => window.location.href = 'checkout.html';
      } catch {
        container.innerHTML = '<p class="text-center text-gray-600">Kesalahan jaringan.</p>';
      }
    }

    async function updateQuantityBackend(itemId, jumlah) {
      if (jumlah < 1) return;
      const token = localStorage.getItem('auth_token');
      try {
        const resp = await fetch(API_BASE + '/carts/items/' + itemId, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
          body: JSON.stringify({ jumlah })
        });
        if (!resp.ok) { API.showModal({ title: 'Keranjang', message: 'Gagal memperbarui jumlah.' }); return; }
        loadCartBackend();
      } catch { API.showModal({ title: 'Jaringan', message: 'Kesalahan jaringan.' }); }
    }

    async function hapusItemBackend(itemId) {
      const token = localStorage.getItem('auth_token');
      try {
        const resp = await fetch(API_BASE + '/carts/items/' + itemId, {
          method: 'DELETE',
          headers: { Authorization: 'Bearer ' + token }
        });
        if (!resp.ok) { API.showModal({ title: 'Keranjang', message: 'Gagal menghapus item.' }); return; }
        loadCartBackend();
      } catch { API.showModal({ title: 'Jaringan', message: 'Kesalahan jaringan.' }); }
    }
  </script>
</body>
</html>
